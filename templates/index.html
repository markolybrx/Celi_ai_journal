<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <link rel="manifest" href="/manifest.json">
    <title>Celi: AI Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('/sw.js'))}</script>
    <style>
        :root { --mood: #00f2fe; --bg: #000; --glass: rgba(20, 20, 25, 0.6); --border: rgba(255, 255, 255, 0.08); }
        
        /* CORE & BG */
        html, body { margin: 0; padding: 0; width: 100%; height: 100dvh; color: #fff; background-color: #000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; position: fixed; }
        #static-background { position: fixed; inset: 0; z-index: -2; background: var(--bg); transition: opacity 0.8s ease; }
        #starfield { position: fixed; inset: 0; z-index: -1; opacity: 0; transition: opacity 0.8s ease; pointer-events: none; }
        body.galaxy-mode #static-background { opacity: 0; }
        body.galaxy-mode #starfield { opacity: 1; pointer-events: auto; }
        
        /* UI ANIMATIONS */
        #main-view { position: absolute; top: 60px; bottom: 0; left: 0; right: 0; overflow-y: auto; padding: 15px 20px 120px 20px; z-index: 10; transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.5s; }
        body.galaxy-mode #main-view { transform: translateY(-120vh); opacity: 0; }
        #bottom-dock { transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        body.galaxy-mode #bottom-dock { transform: translateX(-50%) translateY(150px) !important; }
        .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: rgba(10, 10, 15, 0.7); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 50; transition: transform 0.5s; }
        body.galaxy-mode .app-header { transform: translateY(-100%); } 
        
        /* HEADER */
        .logo-group { display: flex; align-items: baseline; gap: 8px; }
        .logo { font-size: 22px; font-weight: 900; letter-spacing: -1px; } 
        .version-tag { font-size: 10px; opacity: 0.5; font-family: monospace; }
        .header-pfp { width: 36px; height: 36px; border-radius: 50%; background: #222; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); position: relative; z-index: 100; transition: transform 0.2s; } 
        .header-pfp img { width: 100%; height: 100%; object-fit: cover; }
        .header-pfp.pulse-anim { animation: pfpPulse 0.5s ease-in-out; border-color: var(--mood); box-shadow: 0 0 15px var(--mood); }
        
        /* CARDS */
        .rank-card, .calendar-card { background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; backdrop-filter: blur(20px); }
        .rank-card { display: flex; align-items: center; gap: 12px; position: relative; overflow: hidden; cursor: pointer; }
        .rank-icon-container { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: #fff; transition: all 0.5s; z-index: 10; }
        .rank-icon-container svg { width: 100%; height: 100%; filter: drop-shadow(0 0 5px var(--mood)); }
        .progress-bar { height: 3px; background: var(--mood); width: 0%; box-shadow: 0 0 5px var(--mood); transition: width 0.5s ease-out; }
        
        /* BOTTOM DOCK & BUTTONS */
        .bottom-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; height: 65px; background: rgba(15, 15, 20, 0.9); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 35px; z-index: 30; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .nav-group { display: flex; gap: 25px; width: 40%; justify-content: center; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: rgba(255,255,255,0.4); background: none; border: none; gap: 4px; }
        .nav-btn svg { width: 22px; height: 22px; }
        .galaxy-btn-wrapper { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 40; height: 65px; width: 70px; display: flex; align-items: center; justify-content: center; }
        .galaxy-btn { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 4px solid #000; color: #000; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(255, 255, 255, 0.2); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin-bottom: 25px; }
        .galaxy-btn svg { width: 40px; height: 40px; fill: none; transition: fill 0.3s; }
        .galaxy-btn.galaxy-open { background-color: #ef4444; border-color: rgba(20,20,20,0.8); transform: rotate(90deg) scale(1.1); box-shadow: 0 0 30px rgba(239, 68, 68, 0.6); }
        .galaxy-btn.galaxy-open svg { stroke: #fff; width: 32px; height: 32px; }

        /* CALENDAR */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-size: 10px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 6px; color: rgba(255,255,255,0.7); }
        .cal-day.today { background: rgba(255,255,255,0.1); color: #fff; font-weight: 900; }
        .cal-day.has-entry { color: var(--mood); font-weight: bold; }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .chat-window { width: 90%; max-width: 500px; height: 80vh; background: #111; border: 1px solid var(--border); border-radius: 25px; display: flex; flex-direction: column; overflow: hidden; transform: scale(0); opacity: 0; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s; }
        .modal-overlay.active .chat-window { transform: scale(1); opacity: 1; margin: 0; }
        
        .chat-window.origin-void { transform-origin: bottom left; margin-left: 20px; margin-bottom: 100px; }
        .chat-window.origin-ai { transform-origin: bottom right; margin-right: 20px; margin-bottom: 100px; }
        .chat-window.origin-center { transform-origin: center; } 
        
        .chat-header { height: 60px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border); }
        .chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        .msg { max-width: 85%; padding: 14px 18px; border-radius: 20px; font-size: 13.5px; animation: pop 0.4s forwards; }
        .msg-user { align-self: flex-end; background: var(--mood); color: #000; font-weight: 600; }
        .msg-ai { align-self: flex-start; background: rgba(255,255,255,0.08); color: #eee; }
        
        .input-area { padding: 15px; background: rgba(0,0,0,0.95); border-top: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
        .chat-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 25px; padding: 12px 20px; color: #fff; outline: none; }
        .media-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; }
        .media-btn.recording { background: #ef4444; animation: pulse 1s infinite; }
        
        .void-fab { width: 60px; height: 60px; border-radius: 50%; background: #000; display: flex; align-items: center; justify-content: center; animation: voidGlow 3s infinite alternate; }
        .chat-fab { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #f9a8d4, #c084fc); display: flex; align-items: center; justify-content: center; animation: pastelPulse 3s infinite; }
        .void-container { position: fixed; bottom: 100px; left: 20px; z-index: 40; } .fab-container { position: fixed; bottom: 100px; right: 20px; z-index: 40; }
        
        .rank-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s; }
        .rank-row.locked { opacity: 0.4; filter: grayscale(1); }
        .rank-row.active { background: rgba(255,255,255,0.05); border-left: 2px solid var(--mood); }
        .rank-row-icon { width: 30px; height: 30px; margin-right: 12px; }
        .star-rating { display: flex; gap: 2px; justify-content: center; margin-top: 5px; }
        .star-point { width: 10px; height: 10px; fill: var(--mood); filter: drop-shadow(0 0 2px var(--mood)); }
        
        .stardust-particle { position: fixed; width: 4px; height: 4px; background: #fff; border-radius: 50%; pointer-events: none; z-index: 9999; box-shadow: 0 0 4px #fff; animation: fadeParticle 1s forwards; }
        @keyframes voidGlow { from { box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); } to { box-shadow: 0 0 25px rgba(99, 102, 241, 0.6); } }
        @keyframes pastelPulse { 0% { box-shadow: 0 0 0 0 rgba(192, 132, 252, 0.6); } 100% { box-shadow: 0 0 0 15px rgba(192, 132, 252, 0); } }
        @keyframes pfpPulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes fadeParticle { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.5); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* FLOATING CLOSE BTN */
        .floating-close-btn { position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: #ef4444; border-radius: 50%; color: black; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(239, 68, 68, 0.6); cursor: pointer; z-index: 60; transition: transform 0.2s; }
        .floating-close-btn:active { transform: scale(0.9); }
    </style>
</head>
<body>

    <canvas id="starfield"></canvas>
    <div id="void-vignette"></div>
    <div id="static-background"></div>

    <div class="app-header">
        <div class="header-left logo-group">
            <div class="logo">Celi</div><div class="version-tag">v7.1.0</div>
        </div>
        <div class="header-right">
            <div class="header-pfp" id="nav-pfp" onclick="openModal('profile-modal')"><img id="pfp-img" src=""></div>
        </div>
    </div>

    <div id="main-view">
        <div id="rank-card-ui" class="rank-card" onclick="openRanksModal()">
            <div class="rank-icon-container" id="main-rank-icon"></div>
            <div class="rank-details w-full">
                <div id="greeting-text" class="greeting">Good Morning</div>
                <div class="flex justify-between items-end">
                    <div><div id="rank-display" class="rank-title font-bold text-sm">Loading...</div><div id="rank-psyche" class="text-[10px] text-[var(--mood)] uppercase tracking-wide opacity-80">...</div></div>
                    <div id="stardust-cnt" class="text-[9px] opacity-50 font-mono">0 SD</div>
                </div>
                <div class="progress-container mt-2"><div id="rank-progress-bar" class="progress-bar"></div></div>
            </div>
        </div>
        <div class="calendar-card">
            <div class="cal-header"><button class="cal-btn" onclick="changeMonth(-1)">‹</button><div id="cal-month-year" class="cal-title">Loading...</div><button class="cal-btn" onclick="changeMonth(1)">›</button></div>
            <div class="cal-grid" id="cal-grid"></div>
        </div>
    </div>

    <div class="galaxy-btn-wrapper">
        <button id="galaxy-btn" class="galaxy-btn" onclick="toggleGalaxy()">
            <svg id="galaxy-icon-svg" viewBox="0 0 24 24"><g fill="currentColor" stroke="currentColor" stroke-width="0.8"><circle cx="12" cy="12" r="2.5" fill="black" stroke="none" /><path d="M12 12 C14.5 12 16 10 16 8 C16 6 14 5 12 5" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C12 14.5 14 16 16 16 C18 16 19 14 19 12" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C9.5 12 8 14 8 16 C8 18 10 19 12 19" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C12 9.5 10 8 8 8 C6 8 5 10 5 12" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><circle cx="8" cy="8" r="0.5" fill="black" stroke="none" /><circle cx="16" cy="16" r="0.5" fill="black" stroke="none" /><circle cx="16" cy="8" r="0.5" fill="black" stroke="none" /><circle cx="8" cy="16" r="0.5" fill="black" stroke="none" /></g></svg>
        </button>
    </div>

    <div class="bottom-dock" id="bottom-dock">
        <div class="nav-group"><button class="nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg></button><button class="nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg></button></div>
        <div style="width: 70px;"></div>
        <div class="nav-group"><button class="nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M13 10V3L4 14h7v7l9-11h-7z" /></svg></button><button class="nav-btn" onclick="toggleGalaxy()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="5" cy="5" r="1.5"/><circle cx="19" cy="5" r="1.5"/><circle cx="5" cy="19" r="1.5"/><circle cx="19" cy="19" r="1.5"/><path d="M5 5l14 14M5 19L19 5"/></svg></button></div>
    </div>

    <div class="void-container" onclick="openChat('rant')"><div class="void-fab"><svg width="44" height="44" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="11" fill="url(#voidGradient)" /><circle cx="12" cy="12" r="5" fill="black" /><defs><linearGradient id="voidGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#facc15" /><stop offset="40%" stop-color="#f97316" /><stop offset="100%" stop-color="#9333ea" /></linearGradient></defs></svg></div></div>
    <div class="fab-container" onclick="openChat('journal')"><div class="chat-fab"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg></div></div>

    <div id="chat-overlay" class="modal-overlay" onclick="if(event.target.id==='chat-overlay') closeChat()"><div id="chat-modal-window" class="chat-window"><div class="chat-header"><span id="chat-header-title">Celi Neural Link</span><div onclick="closeChat()" class="cursor-pointer">✕</div></div><div id="chat-history" class="chat-history"></div><div class="input-area"><input type="file" id="img-upload" accept="image/*" hidden onchange="handleFileSelect()"><input type="file" id="audio-upload" accept="audio/*" hidden onchange="handleAudioSelect()"><button class="media-btn" onclick="document.getElementById('img-upload').click()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></button><button class="media-btn" id="mic-btn" onclick="toggleMic()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></button><input type="text" id="chat-input" class="chat-input" placeholder="Signal..." onkeypress="if(event.key==='Enter') sendMessage()"><button onclick="sendMessage()" class="ml-2 text-white">➤</button></div></div></div>
    
    <div id="ranks-modal" class="modal-overlay" onclick="if(event.target.id==='ranks-modal') closeModal('ranks-modal')"><div class="bg-[#111] border border-white/10 p-0 rounded-3xl w-full max-w-sm relative max-h-[85vh] flex flex-col overflow-hidden"><div class="flex flex-col items-center pt-8 pb-4 px-6 bg-gradient-to-b from-white/5 to-transparent"><div id="modal-rank-icon" class="w-20 h-20 text-[var(--mood)] drop-shadow-[0_0_10px_var(--mood)]"></div><div id="modal-stars" class="star-rating my-2"></div><h2 id="modal-rank-name" class="text-2xl font-bold tracking-wide mt-1">...</h2><div class="w-full h-1.5 bg-white/10 rounded-full mt-4 overflow-hidden relative"><div id="modal-progress-bar" class="h-full bg-[var(--mood)] shadow-[0_0_10px_var(--mood)] absolute top-0 left-0 transition-all duration-1000" style="width: 0%"></div></div><p id="modal-sd-text" class="text-[10px] text-white/50 mt-1 font-mono">0 SD</p></div><div class="flex-1 overflow-y-auto" id="ranks-list-container"></div><div class="p-4 border-t border-white/5"><button onclick="closeModal('ranks-modal')" class="w-full py-3 bg-[#ef4444] text-black font-bold uppercase rounded-xl shadow-lg active:scale-95 transition-transform text-xs tracking-widest">Close Terminal</button></div></div></div>
    
    <div id="archive-modal" class="modal-overlay"><div class="chat-window origin-center" style="height: 60vh; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2);"><div class="chat-header"><span id="archive-date" class="font-mono text-xs opacity-50 tracking-widest">ARCHIVE</span><div onclick="closeArchive()" class="cursor-pointer">✕</div></div><div class="p-6 overflow-y-auto flex flex-col gap-4 items-center"><div id="archive-image-container" class="w-full rounded-xl overflow-hidden hidden"><img id="archive-image" class="w-full object-cover"></div><div id="archive-audio-container" class="w-full hidden"><audio id="archive-audio" controls class="w-full"></audio></div><h3 class="text-xs font-bold uppercase tracking-widest text-[var(--mood)] w-full text-center">Soul Synthesis</h3><p id="archive-analysis" class="text-sm italic text-gray-300 leading-relaxed text-center"></p><div class="w-full h-px bg-white/10 my-2"></div><div class="w-full text-[9px] text-center opacity-30 uppercase">Recorded Memory</div></div></div></div>

    <div id="profile-modal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-5 backdrop-blur-sm">
        <div class="bg-[#111] border border-white/10 p-0 rounded-3xl w-full max-w-sm relative max-h-[85vh] flex flex-col overflow-hidden">
            <div class="floating-close-btn" onclick="closeModal('profile-modal')">✕</div>

            <div class="p-6 border-b border-white/5"><h2 class="text-xl font-bold tracking-wide">Profile</h2></div>
            <div class="flex-1 overflow-y-auto p-6 flex flex-col items-center gap-6">
                <div class="flex flex-col items-center relative">
                    <img id="profile-pfp-large" class="w-24 h-24 rounded-full border-2 border-white/20 object-cover" src="">
                    <input type="file" id="pfp-upload-input" accept="image/*" hidden onchange="handlePfpUpload()">
                    <button onclick="document.getElementById('pfp-upload-input').click()" class="mt-3 text-xs text-[var(--mood)] border border-[var(--mood)] px-3 py-1 rounded-full uppercase tracking-widest hover:bg-[var(--mood)] hover:text-black transition-colors">Update Photo</button>
                </div>

                <div class="w-full space-y-4">
                    <div class="bg-white/5 p-4 rounded-xl border border-white/5"><label class="block text-[9px] uppercase tracking-widest text-white/40 mb-1">Full Name</label><div id="profile-fullname" class="text-sm font-semibold">Loading...</div></div>
                    <div class="bg-white/5 p-4 rounded-xl border border-white/5"><label class="block text-[9px] uppercase tracking-widest text-white/40 mb-1">User ID</label><div id="profile-id" class="text-xs font-mono opacity-70 break-all">...</div></div>
                    <div class="flex gap-4">
                        <div class="bg-white/5 p-4 rounded-xl border border-white/5 flex-1"><label class="block text-[9px] uppercase tracking-widest text-white/40 mb-1">Aura Color</label><div class="flex items-center gap-2"><div id="profile-color-dot" class="w-3 h-3 rounded-full bg-white"></div><span id="profile-color-text" class="text-xs opacity-70">...</span></div></div>
                        <div class="bg-white/5 p-4 rounded-xl border border-white/5 flex-1"><label class="block text-[9px] uppercase tracking-widest text-white/40 mb-1">Secret Q</label><div id="profile-secret-q" class="text-xs opacity-70 truncate">...</div></div>
                    </div>
                </div>

                <div class="w-full space-y-3 pt-2">
                    <button onclick="window.location.href='/logout'" class="w-full py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-xs font-bold uppercase tracking-widest transition-colors">Log Out</button>
                    <div class="flex gap-3">
                        <button onclick="openModal('change-pass-modal')" class="flex-1 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-[10px] font-bold uppercase tracking-widest">Change Pass</button>
                        <button onclick="openModal('change-secret-modal')" class="flex-1 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-[10px] font-bold uppercase tracking-widest">Change Secret</button>
                    </div>
                    <button onclick="clearMemory()" class="w-full py-3 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 rounded-xl text-xs font-bold uppercase tracking-widest transition-colors">Delete Data</button>
                </div>

                <div class="w-full pt-4 border-t border-white/5 text-center">
                    <button onclick="openModal('policy-modal')" class="text-[10px] uppercase tracking-widest text-blue-400 hover:text-blue-300 underline">View User Data & Privacy Policy</button>
                </div>
            </div>
        </div>
    </div>

    <div id="change-pass-modal" class="fixed inset-0 bg-black/90 z-[60] hidden items-center justify-center p-5 backdrop-blur-sm"><div class="bg-[#111] border border-white/10 p-6 rounded-2xl w-full max-w-xs relative"><div class="absolute top-2 right-2 cursor-pointer p-2" onclick="closeModal('change-pass-modal')">✕</div><h3 class="text-lg font-bold mb-4">New Password</h3><input type="password" id="new-pass-input" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-sm mb-4 outline-none focus:border-[var(--mood)]" placeholder="Enter new password"><button onclick="updateSecurity('pass')" class="w-full py-3 bg-[var(--mood)] text-black font-bold rounded-lg text-xs uppercase tracking-widest">Update</button></div></div>
    <div id="change-secret-modal" class="fixed inset-0 bg-black/90 z-[60] hidden items-center justify-center p-5 backdrop-blur-sm"><div class="bg-[#111] border border-white/10 p-6 rounded-2xl w-full max-w-xs relative"><div class="absolute top-2 right-2 cursor-pointer p-2" onclick="closeModal('change-secret-modal')">✕</div><h3 class="text-lg font-bold mb-4">New Security</h3><input type="text" id="new-secret-q" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-sm mb-2 outline-none focus:border-[var(--mood)]" placeholder="New Secret Question"><input type="text" id="new-secret-a" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-sm mb-4 outline-none focus:border-[var(--mood)]" placeholder="New Secret Answer"><button onclick="updateSecurity('secret')" class="w-full py-3 bg-[var(--mood)] text-black font-bold rounded-lg text-xs uppercase tracking-widest">Update</button></div></div>
    
    <div id="policy-modal" class="fixed inset-0 bg-black/90 z-[70] hidden items-center justify-center p-5 backdrop-blur-sm" onclick="if(event.target.id==='policy-modal') closeModal('policy-modal')">
        <div class="bg-white text-black p-0 rounded-xl w-full max-w-md h-[80vh] flex flex-col overflow-hidden relative">
            <div class="absolute top-2 right-2 z-10"><button onclick="closeModal('policy-modal')" class="w-8 h-8 bg-red-500 text-white rounded-full font-bold flex items-center justify-center shadow-lg">✕</button></div>
            <div class="flex-1 overflow-y-auto"><iframe src="/privacy_policy" class="w-full h-full border-none"></iframe></div>
        </div>
    </div>

    <script>
        // GLOBAL STATE
        let isProcessing = false; let currentCalendarDate = new Date(); let fullChatHistory = {}; let userHistoryDates = []; let currentMode = 'journal'; 
        let activeMediaFile = null; let activeAudioFile = null;
        let globalRankTree = null; let currentLockIcon = '';
        const STAR_SVG = `<svg class="star-point" viewBox="0 0 24 24"><path d="M12 2l2.4 7.2h7.6l-6 4.8 2.4 7.2-6-4.8-6 4.8 2.4-7.2-6-4.8h7.6z"/></svg>`;

        // --- SONIC ENGINE ---
        const SonicAtmosphere = {
            ctx: null, nodes: [], active: false,
            init: function() { if(this.ctx) return; const AudioContext = window.AudioContext || window.webkitAudioContext; this.ctx = new AudioContext(); },
            toggle: function() { this.init(); if(this.ctx.state === 'suspended') this.ctx.resume(); this.active = !this.active; if(this.active) this.playMode(currentMode); else this.stop(); },
            playMode: function(mode) { if(!this.active) return; this.stop(); const t = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.type = mode === 'journal' ? 'sine' : 'triangle'; osc.frequency.setValueAtTime(mode === 'journal' ? 220 : 55, t); gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(mode === 'journal' ? 0.05 : 0.1, t+2); osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); this.nodes.push({stop: ()=> { gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime+1); setTimeout(()=>osc.stop(), 1000); }}); },
            stop: function() { this.nodes.forEach(n => n.stop()); this.nodes = []; }
        };

        // --- GALAXY ENGINE ---
        const canvas = document.getElementById('starfield'); const ctx = canvas.getContext('2d'); let stars = []; let animationFrameId; let isGalaxyActive = false; let galaxyData = [];
        function resizeStars() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; } window.addEventListener('resize', resizeStars); resizeStars();
        canvas.addEventListener('click', (e) => { if(!isGalaxyActive) return; const rect = canvas.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; galaxyData.forEach(star => { if(Math.hypot(x-star.x, y-star.y) < 20) openArchive(star.id); }); });
        async function toggleGalaxy() { const btn = document.getElementById('galaxy-btn'); isGalaxyActive = !isGalaxyActive; if (isGalaxyActive) { btn.classList.add('galaxy-open'); btn.innerHTML = '✕'; document.body.classList.add('galaxy-mode'); SonicAtmosphere.playMode('galaxy'); const res = await fetch('/api/galaxy_map'); const data = await res.json(); galaxyData = data.map(d => ({ ...d, x: Math.random() * (canvas.width - 40) + 20, y: Math.random() * (canvas.height - 40) + 20, r: d.type === 'void' ? 2 : 4, color: d.type === 'void' ? '#ef4444' : '#ffffff', vx: (Math.random() - 0.5) * 0.2, vy: (Math.random() - 0.5) * 0.2 })); animateStars(); } else { btn.classList.remove('galaxy-open'); btn.innerHTML = `<svg id="galaxy-icon-svg" viewBox="0 0 24 24"><g fill="currentColor" stroke="currentColor" stroke-width="0.8"><circle cx="12" cy="12" r="2.5" fill="black" stroke="none" /><path d="M12 12 C14.5 12 16 10 16 8 C16 6 14 5 12 5" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C12 14.5 14 16 16 16 C18 16 19 14 19 12" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C9.5 12 8 14 8 16 C8 18 10 19 12 19" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C12 9.5 10 8 8 8 C6 8 5 10 5 12" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><circle cx="8" cy="8" r="0.5" fill="black" stroke="none" /><circle cx="16" cy="16" r="0.5" fill="black" stroke="none" /><circle cx="16" cy="8" r="0.5" fill="black" stroke="none" /><circle cx="8" cy="16" r="0.5" fill="black" stroke="none" /></g></svg>`; document.body.classList.remove('galaxy-mode'); SonicAtmosphere.playMode('journal'); cancelAnimationFrame(animationFrameId); } }
        function animateStars() { if(!isGalaxyActive) return; ctx.clearRect(0,0,canvas.width,canvas.height); galaxyData.forEach(star => { star.x += star.vx; star.y += star.vy; if(star.x < 0 || star.x > canvas.width) star.vx *= -1; if(star.y < 0 || star.y > canvas.height) star.vy *= -1; if (star.type === 'void') { galaxyData.forEach(other => { if (other !== star && Math.hypot(star.x - other.x, star.y - other.y) < 150) { other.vx += (star.x - other.x) * 0.0001; other.vy += (star.y - other.y) * 0.0001; } }); } }); ctx.lineWidth = 0.5; ctx.strokeStyle = "rgba(255,255,255,0.15)"; galaxyData.forEach((star, i) => { if (star.x < -10 || star.x > canvas.width + 10 || star.y < -10 || star.y > canvas.height + 10) return; if (galaxyData[i+1] && galaxyData[i+1].group === star.group) { ctx.beginPath(); ctx.moveTo(star.x, star.y); ctx.lineTo(galaxyData[i+1].x, galaxyData[i+1].y); ctx.stroke(); } ctx.beginPath(); ctx.arc(star.x, star.y, star.r, 0, Math.PI*2); ctx.fillStyle = star.color; ctx.shadowBlur = 10; ctx.shadowColor = star.color; ctx.fill(); if (star.constellation_name) { ctx.font = "10px monospace"; ctx.fillStyle = "rgba(255,255,255,0.5)"; ctx.fillText(star.constellation_name, star.x + 10, star.y); } }); animationFrameId = requestAnimationFrame(animateStars); }

        // --- CORE LOGIC ---
        async function loadData() {
            try {
                const res = await fetch('/api/data'); if(!res.ok) return;
                const data = await res.json();
                if(data.status === 'guest') { window.location.href='/login'; return; }
                
                globalRankTree = data.progression_tree; currentLockIcon = data.progression_tree.lock_icon;
                document.getElementById('greeting-text').innerText = `Good Day, ${data.first_name}`;
                document.getElementById('rank-display').innerText = data.rank; document.getElementById('rank-psyche').innerText = data.rank_psyche;
                document.getElementById('rank-progress-bar').style.width = `${data.rank_progress}%`; document.getElementById('stardust-cnt').innerText = `${data.stardust_current}/${data.stardust_max} SD`;
                document.getElementById('pfp-img').src = data.profile_pic || ''; document.documentElement.style.setProperty('--mood', data.current_color);
                document.getElementById('main-rank-icon').innerHTML = data.current_svg;
                
                // Profile Injects
                document.getElementById('profile-pfp-large').src = data.profile_pic || '';
                document.getElementById('profile-fullname').innerText = `${data.first_name} ${data.last_name}`;
                document.getElementById('profile-id').innerText = data.user_id;
                document.getElementById('profile-color-text').innerText = data.aura_color;
                document.getElementById('profile-color-dot').style.backgroundColor = data.aura_color;
                document.getElementById('profile-secret-q').innerText = data.secret_question;

                if(data.history) fullChatHistory = data.history; userHistoryDates = Object.values(data.history).map(e=>e.date); renderCalendar();
            } catch(e) { console.error(e); }
        }

        // --- INTERACTION HANDLERS ---
        async function handlePfpUpload() {
            const input = document.getElementById('pfp-upload-input');
            if(input.files && input.files[0]) {
                const formData = new FormData(); formData.append('pfp', input.files[0]);
                const res = await fetch('/api/update_pfp', { method: 'POST', body: formData });
                const data = await res.json();
                if(data.status === 'success') { 
                    document.getElementById('pfp-img').src = data.url; 
                    document.getElementById('profile-pfp-large').src = data.url; 
                }
            }
        }

        async function updateSecurity(type) {
            let body = {};
            if(type === 'pass') { body = { new_password: document.getElementById('new-pass-input').value }; }
            else { body = { new_secret_q: document.getElementById('new-secret-q').value, new_secret_a: document.getElementById('new-secret-a').value }; }
            
            const res = await fetch('/api/update_security', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
            const data = await res.json();
            if(data.status === 'success') { alert("Updated Successfully"); closeModal('change-pass-modal'); closeModal('change-secret-modal'); }
            else { alert("Error: " + data.message); }
        }

        function openRanksModal() { if (!globalRankTree) return; const list = document.getElementById('ranks-list-container'); list.innerHTML = ''; const modal = document.getElementById('ranks-modal'); modal.classList.add('active'); document.getElementById('modal-rank-icon').innerHTML = document.getElementById('main-rank-icon').innerHTML; document.getElementById('modal-rank-name').innerText = document.getElementById('rank-display').innerText; document.getElementById('modal-stars').innerHTML = getStarsHTML(document.getElementById('rank-display').innerText); document.getElementById('modal-progress-bar').style.width = document.getElementById('rank-progress-bar').style.width; document.getElementById('modal-sd-text').innerText = document.getElementById('stardust-cnt').innerText; const currentUserRankIndex = globalRankTree.ranks.findIndex(r => r.title === document.getElementById('rank-display').innerText); globalRankTree.ranks.forEach((rank, index) => { const isUnlocked = index <= currentUserRankIndex; const isNext = index === currentUserRankIndex + 1; const row = document.createElement('div'); row.className = `rank-row ${!isUnlocked && !isNext ? 'locked' : ''} ${index === currentUserRankIndex ? 'active' : ''}`; let iconHtml = isUnlocked ? rank.svg : currentLockIcon; let statusText = rank.desc; if(isNext) statusText = `Unlock: ${rank.req} SD`; if(index > currentUserRankIndex + 1) statusText = "Locked"; row.innerHTML = `<div class="rank-row-icon" style="color: ${isUnlocked ? rank.color : '#555'}">${iconHtml}</div><div class="flex-1"><div class="flex justify-between items-center"><span class="font-bold text-sm" style="color: ${isUnlocked ? '#fff' : '#777'}">${rank.title}</span>${index === currentUserRankIndex ? `<span class="text-[10px] bg-white/10 px-2 rounded text-[${rank.color}]">CURRENT</span>` : ''}</div><div class="text-[10px] opacity-60 font-mono tracking-wide">${statusText}</div></div>`; list.appendChild(row); }); setTimeout(() => { const active = list.querySelector('.active'); if(active) active.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 100); }
        function getStarsHTML(rankTitle) { let count = 0; if (rankTitle.includes("VI")) count = 6; else if (rankTitle.includes("IV")) count = 4; else if (rankTitle.includes("V")) count = 5; else if (rankTitle.includes("III")) count = 3; else if (rankTitle.includes("II")) count = 2; else if (rankTitle.includes("I")) count = 1; if(rankTitle.includes("Ethereal") && count > 5) count = 5; return Array(count).fill(STAR_SVG).join(''); }
        function handleFileSelect() { const input = document.getElementById('img-upload'); if(input.files && input.files[0]) { activeMediaFile = input.files[0]; document.getElementById('chat-input').placeholder = "Image attached. Add context..."; } }
        function handleAudioSelect() { const input = document.getElementById('audio-upload'); if(input.files && input.files[0]) { activeAudioFile = input.files[0]; document.getElementById('chat-input').placeholder = "Audio attached. Transmitting..."; sendMessage(); } }
        function toggleMic() { document.getElementById('audio-upload').click(); }
        async function sendMessage() { if(isProcessing) return; const input = document.getElementById('chat-input'); const msg = input.value.trim(); if(!msg && !activeMediaFile && !activeAudioFile) return; appendMsg(msg || "[Media Transmitting...]", 'user'); input.value=''; isProcessing=true; const formData = new FormData(); formData.append('message', msg); formData.append('mode', currentMode); if(activeMediaFile) formData.append('media', activeMediaFile); if(activeAudioFile) formData.append('audio', activeAudioFile); try { const res = await fetch('/api/process', { method:'POST', body: formData }); const data = await res.json(); appendMsg(data.reply, 'ai'); if(data.command === 'daily_reward' || data.command === 'level_up') spawnStardust(); if(data.command === 'switch_to_void') setTimeout(()=>openChat('rant'), 1000); activeMediaFile = null; activeAudioFile = null; document.getElementById('chat-input').placeholder = "Signal..."; await loadData(); } catch(e) { appendMsg("Transmission failed.", 'ai'); } isProcessing=false; }
        function openArchive(id) { const modal = document.getElementById('archive-modal'); modal.classList.add('active'); fetch('/api/star_detail', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}).then(r=>r.json()).then(d=>{ document.getElementById('archive-date').innerText = d.date; document.getElementById('archive-analysis').innerText = d.analysis || "Analysis corrupted."; const imgContainer = document.getElementById('archive-image-container'); if(d.image_url) { imgContainer.classList.remove('hidden'); document.getElementById('archive-image').src = d.image_url; } else { imgContainer.classList.add('hidden'); } const audioContainer = document.getElementById('archive-audio-container'); const audioEl = document.getElementById('archive-audio'); if(d.audio_url) { audioContainer.classList.remove('hidden'); audioEl.src = d.audio_url; } else { audioContainer.classList.add('hidden'); } }); }
        function appendMsg(txt, sender) { const div = document.createElement('div'); div.className = `msg msg-${sender}`; div.innerText = txt; document.getElementById('chat-history').appendChild(div); document.getElementById('chat-history').scrollTop = 9999; }
        function openChat(mode) { currentMode = mode; SonicAtmosphere.playMode(mode); document.getElementById('chat-overlay').classList.add('active'); const w = document.getElementById('chat-modal-window'); w.className = `chat-window origin-${mode === 'rant' ? 'void' : 'ai'}`; document.getElementById('chat-header-title').innerText = mode === 'rant' ? "THE VOID" : "CELI AI"; renderChatHistory(fullChatHistory); }
        function closeChat() { document.getElementById('chat-overlay').classList.remove('active'); SonicAtmosphere.playMode('journal'); }
        function openModal(id) { document.getElementById(id).style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function closeArchive() { document.getElementById('archive-modal').classList.remove('active'); document.getElementById('archive-audio').pause(); }
        function spawnStardust() { const s=document.getElementById('nav-pfp').getBoundingClientRect(); const t=document.getElementById('rank-progress-bar').getBoundingClientRect(); const pfp=document.getElementById('nav-pfp'); pfp.classList.remove('pulse-anim'); void pfp.offsetWidth; pfp.classList.add('pulse-anim'); for(let i=0;i<8;i++){ setTimeout(()=>{ const p=document.createElement('div'); p.className='stardust-particle'; p.style.left=(s.left+s.width/2)+'px'; p.style.top=(s.top+s.height/2)+'px'; document.body.appendChild(p); const tx=t.left+Math.random()*t.width; const ty=t.top+t.height/2; p.animate([{transform:'translate(0,0) scale(1)',opacity:1},{transform:`translate(${tx-parseFloat(p.style.left)}px, ${ty-parseFloat(p.style.top)}px) scale(0.5)`,opacity:0}],{duration:800+Math.random()*400,easing:'cubic-bezier(0.25,1,0.5,1)'}).onfinish=()=>p.remove(); },i*100); } }
        function renderCalendar() { const g=document.getElementById('cal-grid'); g.innerHTML=''; const m=currentCalendarDate.getMonth(); const y=currentCalendarDate.getFullYear(); document.getElementById('cal-month-year').innerText=new Date(y,m).toLocaleString('default',{month:'long',year:'numeric'}); ["S","M","T","W","T","F","S"].forEach(d=>g.innerHTML+=`<div>${d}</div>`); const days=new Date(y,m+1,0).getDate(); const f=new Date(y,m,1).getDay(); for(let i=0;i<f;i++)g.innerHTML+=`<div></div>`; for(let i=1;i<=days;i++){ const d=document.createElement('div'); d.className='cal-day'; d.innerText=i; if(userHistoryDates.includes(`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`)) d.classList.add('has-entry'); g.appendChild(d); } }
        function changeMonth(d) { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+d); renderCalendar(); }
        function renderChatHistory(h) { const c = document.getElementById('chat-history'); c.innerHTML=''; Object.keys(h).sort().slice(-50).forEach(k => { appendMsg(h[k].summary||"Entry", 'user'); appendMsg(h[k].reply, 'ai'); }); }
        async function clearMemory() { if(confirm("Wipe?")) { await fetch('/api/clear_history',{method:'POST'}); window.location.reload(); } }
        window.onload = loadData;
    </script>
</body>
</html>
