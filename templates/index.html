<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Celi: AI Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mood: #00f2fe; --bg: #050505; --glass: rgba(20,20,25,0.6); }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .app-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); z-index: 20; }
        .logo { font-weight: 900; letter-spacing: -1px; font-size: 20px; color: #fff; }
        .avatar-btn { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--mood); overflow: hidden; cursor: pointer; }
        .chat-zone { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; word-wrap: break-word; animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .msg-user { align-self: flex-end; background: var(--mood); color: #000; border-bottom-right-radius: 2px; font-weight: 500; }
        .msg-ai { align-self: flex-start; background: rgba(255,255,255,0.08); color: #e0e0e0; border-bottom-left-radius: 2px; border: 1px solid rgba(255,255,255,0.05); }
        .msg-ai strong { color: var(--mood); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .input-deck { padding: 15px; background: rgba(10,10,10,0.8); border-top: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(20px); }
        .mode-bar { display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 5px; }
        .mode-pill { padding: 6px 14px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); color: #666; transition: all 0.3s; white-space: nowrap; }
        .mode-pill.active { background: var(--mood); color: #000; border-color: var(--mood); box-shadow: 0 0 10px var(--mood); }
        .input-wrapper { display: flex; gap: 10px; align-items: center; position: relative; }
        .chat-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; padding: 12px 20px; color: #fff; outline: none; transition: 0.3s; }
        .chat-input:focus { border-color: var(--mood); background: rgba(0,0,0,0.5); }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--mood); color: #000; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; }
        .send-btn:active { transform: scale(0.9); }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 40; display: none; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s; }
        .drawer { position: fixed; top: 0; right: -300px; width: 85%; max-width: 300px; height: 100%; background: #0a0a0a; border-left: 1px solid rgba(255,255,255,0.1); z-index: 50; padding: 30px; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .drawer.open { right: 0; }
        .stat-card { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .stat-val { font-size: 24px; font-weight: 800; color: var(--mood); }
        .stat-lbl { font-size: 10px; opacity: 0.5; text-transform: uppercase; letter-spacing: 2px; }
        .loader-dots div { animation: pulse 0.6s infinite alternate; }
        .loader-dots div:nth-child(2) { animation-delay: 0.2s; }
        .loader-dots div:nth-child(3) { animation-delay: 0.4s; }
        
        /* NEW: STARS */
        .star-track { display: flex; justify-content: center; gap: 4px; margin-top: 5px; }
        .star { font-size: 14px; color: rgba(255,255,255,0.2); }
        .star.filled { color: var(--mood); text-shadow: 0 0 5px var(--mood); }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="logo">Celi v3.1</div>
        <div class="avatar-btn" onclick="toggleDrawer(true)">
            <img id="nav-pfp" class="w-full h-full object-cover" src="">
        </div>
    </div>

    <div id="chat-zone" class="chat-zone">
        <div class="msg msg-ai">System Online. Select a frequency below.</div>
    </div>

    <div class="input-deck">
        <div class="mode-bar">
            <div class="mode-pill active" onclick="setMode('orbit', this)">Orbit (Chat)</div>
            <div class="mode-pill" onclick="setMode('void', this)">The Void (Vent)</div>
            <div class="mode-pill" onclick="requestTrivia()">✨ Trivia</div>
        </div>
        <div class="input-wrapper">
            <input type="text" id="msg-input" class="chat-input" placeholder="Broadcast signal..." onkeypress="handleKey(event)">
            <button class="send-btn" onclick="send()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
        </div>
    </div>

    <div id="overlay" class="drawer-overlay" onclick="toggleDrawer(false)"></div>
    <div id="drawer" class="drawer">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl font-bold text-white">Profile</h2>
            <button onclick="toggleDrawer(false)" class="text-gray-500">✕</button>
        </div>
        <div class="flex flex-col items-center mb-8">
            <div class="w-24 h-24 rounded-full border-4 border-[var(--mood)] overflow-hidden mb-3">
                <img id="drawer-pfp" class="w-full h-full object-cover">
            </div>
            <h3 id="u-name" class="text-lg font-bold">User</h3>
            <span id="u-rank" class="text-xs px-3 py-1 bg-white/10 rounded-full mt-2 text-[var(--mood)] uppercase tracking-widest border border-white/10">Observer I</span>
            
            <div id="star-container" class="star-track"></div>
        </div>
        <div class="stat-card"><div id="u-points" class="stat-val">0</div><div class="stat-lbl">Stardust Collected</div></div>
        <div class="bg-white/5 p-4 rounded-xl mb-auto border border-white/5">
            <h4 class="text-[9px] uppercase tracking-widest text-gray-500 mb-2 font-bold">Soul Resonance</h4>
            <p id="u-analysis" class="text-xs text-gray-300 italic leading-relaxed">"Calibrating..."</p>
        </div>
        <button onclick="window.location.href='/logout'" class="w-full py-3 border border-red-500/30 text-red-400 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-red-500/10 transition">Sever Link</button>
    </div>

    <script>
        let currentMode = 'orbit';
        let isBusy = false;

        async function init() {
            try {
                const res = await fetch('/api/data');
                const d = await res.json();
                if(d.status === 'guest') return window.location.href = '/login';

                document.getElementById('nav-pfp').src = d.profile_pic || "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCIvPjwvc3ZnPg==";
                document.getElementById('drawer-pfp').src = document.getElementById('nav-pfp').src;
                document.getElementById('u-name').innerText = d.username;
                document.getElementById('u-rank').innerText = d.rank;
                document.getElementById('u-points').innerText = d.points;
                if(d.celi_analysis) document.getElementById('u-analysis').innerText = `"${d.celi_analysis}"`;
                if(d.fav_color) document.documentElement.style.setProperty('--mood', d.fav_color);

                // RENDER STARS
                const sCon = document.getElementById('star-container');
                sCon.innerHTML = '';
                for(let i=0; i<d.stars_total; i++) {
                    const s = document.createElement('span');
                    s.className = `star ${i < d.stars_current ? 'filled' : ''}`;
                    s.innerHTML = '★';
                    sCon.appendChild(s);
                }

                if(d.history) {
                    const box = document.getElementById('chat-zone');
                    if(box.children.length <= 1) {
                        const times = Object.keys(d.history).sort((a,b) => a-b).slice(-50);
                        times.forEach(t => {
                            const item = d.history[t];
                            addMsg(item.summary || "Log", 'user');
                            addMsg(item.reply, 'ai');
                        });
                    }
                }
            } catch(e) { console.log("Sync Fail"); }
        }

        function setMode(mode, btn) {
            currentMode = mode;
            document.querySelectorAll('.mode-pill').forEach(p => p.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        // NEW: TRIVIA FUNCTION
        function requestTrivia() {
            document.getElementById('msg-input').value = "Give me some trivia!";
            send();
        }

        function toggleDrawer(open) {
            const d = document.getElementById('drawer');
            const o = document.getElementById('overlay');
            if(open) { o.style.display='block'; setTimeout(()=>o.style.opacity=1,10); d.classList.add('open'); }
            else { o.style.opacity=0; d.classList.remove('open'); setTimeout(()=>o.style.display='none',300); }
        }

        async function send() {
            if(isBusy) return;
            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            if(!txt) return;

            addMsg(txt, 'user');
            input.value = '';
            isBusy = true;

            const tId = 'typ-' + Date.now();
            const box = document.getElementById('chat-zone');
            const tDiv = document.createElement('div');
            tDiv.id = tId; tDiv.className = 'msg msg-ai loader-dots flex gap-1 px-4 py-3';
            tDiv.innerHTML = '<div class="w-1.5 h-1.5 bg-gray-400 rounded-full"></div><div class="w-1.5 h-1.5 bg-gray-400 rounded-full"></div><div class="w-1.5 h-1.5 bg-gray-400 rounded-full"></div>';
            box.appendChild(tDiv); box.scrollTop = box.scrollHeight;

            try {
                const res = await fetch('/api/process', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({message: txt, mode: currentMode})
                });
                const d = await res.json();
                document.getElementById(tId).remove();
                addMsg(d.reply, 'ai');
                init();
            } catch {
                document.getElementById(tId).remove();
                addMsg("Signal Lost.", 'ai');
            }
            isBusy = false;
        }

        function addMsg(txt, type) {
            const div = document.createElement('div');
            div.className = `msg msg-${type}`;
            if(type === 'ai') div.innerHTML = parseMD(txt);
            else div.innerText = txt;
            const box = document.getElementById('chat-zone');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function parseMD(txt) { return txt.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); }
        function handleKey(e) { if(e.key==='Enter') send(); }
        window.onload = init;
    </script>
</body>
</html>
