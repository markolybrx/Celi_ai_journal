<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CELI</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; color: #fff; font-family: monospace; overflow: hidden; height: 100dvh; margin: 0; }
        #universe { position: absolute; height: 100dvh; display: flex; transition: transform 1s cubic-bezier(0.2, 0, 0.2, 1); will-change: transform; }
        .sector { width: 100vw; height: 100dvh; position: relative; flex-shrink: 0; border-right: 1px solid #111; }
        .star { position: absolute; border-radius: 50%; z-index: 10; transition: all 2s ease-in-out; }
        
        /* HUD and UI */
        .glass { background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); }
        .god-mode #hud, .god-mode #ui { opacity: 0; pointer-events: none; }
        .god-mode #universe { transform: scale(0.1) !important; flex-wrap: wrap; width: 500vw !important; }
        .map-view { transform: scale(0.2) !important; }
    </style>
</head>
<body>

    <div id="universe"></div>

    <div id="hud" class="fixed top-0 inset-x-0 p-6 z-50 flex justify-between items-start pointer-events-none transition-opacity">
        <div class="pointer-events-auto">
            <div id="rank" class="text-[10px] tracking-[0.5em] text-indigo-500 font-bold">LEVEL: NEOPHYTE</div>
            <div id="sector-label" class="text-[8px] text-gray-500 mt-1 uppercase tracking-widest">Sector 0</div>
        </div>
        <div class="flex gap-2 pointer-events-auto">
            <button onclick="toggleMap()" class="px-3 py-2 border border-white/10 text-[9px] uppercase">Map</button>
            <button id="god-btn" onclick="toggleGod()" class="hidden px-3 py-2 border border-indigo-500 text-indigo-400 text-[9px] uppercase">God View</button>
        </div>
    </div>

    <div id="ui" class="fixed bottom-0 inset-x-0 p-6 z-50 transition-opacity">
        <div id="terminal" class="mb-4 h-24 overflow-y-auto text-[10px] text-gray-400 space-y-1 uppercase"></div>
        <div class="flex border-b border-white/20 pb-2">
            <input id="input" class="bg-transparent flex-grow outline-none text-xs" placeholder="LOG ENTRY..." onkeydown="if(event.key==='Enter') send()">
            <button onclick="send()" class="text-[10px] font-bold text-indigo-400 ml-4">SEND</button>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js'); }

        let state = JSON.parse(localStorage.getItem('celi_data')) || { sectors: [{ stars: [] }], badges: [], currentIdx: 0 };
        const SHAPES = {
            "Sigil-Heart": (i, t) => { const a = (i/t)*2*Math.PI; return { x: 50+1.2*(16*Math.pow(Math.sin(a),3)), y: 50-1.2*(13*Math.cos(a)-5*Math.cos(2*a)-2*Math.cos(3*a)-Math.cos(4*a)) }; },
            "Sigil-Shield": (i, t) => { const a = (i/t)*2*Math.PI; return { x: 50+22*Math.cos(a), y: 50+20*Math.sin(a)*(Math.abs(Math.cos(a))+0.5) }; },
            "Sigil-ZenITH": (i, t) => { const a = (i/t)*2*Math.PI; return { x: 50+20*Math.cos(a), y: 50+20*Math.sin(a) }; }
        };

        async function send() {
            const el = document.getElementById('input'); const val = el.value.trim(); if(!val) return;
            el.value = '';

            const res = await fetch('/api/process', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: val, profile: state, current_star_count: state.sectors[state.currentIdx].stars.length })
            });
            const data = await res.json();
            
            addLog(data.reply);
            const cur = state.sectors[state.currentIdx];
            cur.stars.push({ color: data.color, x: 15 + Math.random()*70, y: 20 + Math.random()*60 });

            if (data.close_sector) {
                const shapeFn = SHAPES[data.shape] || SHAPES["Sigil-ZenITH"];
                cur.stars.forEach((s, idx) => { const p = shapeFn(idx, cur.stars.length); s.x = p.x; s.y = p.y; });
                state.badges.push(data.shape);
                state.sectors.push({ stars: [] });
                state.currentIdx++;
            }

            localStorage.setItem('celi_data', JSON.stringify(state));
            render();
        }

        function render() {
            const uni = document.getElementById('universe'); uni.innerHTML = '';
            state.sectors.forEach(sec => {
                const div = document.createElement('div'); div.className = 'sector';
                sec.stars.forEach(s => {
                    const st = document.createElement('div'); st.className = 'star';
                    st.style.cssText = `width:2px; height:2px; left:${s.x}%; top:${s.y}%; background:${s.color}; box-shadow: 0 0 10px ${s.color};`;
                    div.appendChild(st);
                });
                uni.appendChild(div);
            });
            updateHUD();
            jump(state.currentIdx);
        }

        function updateHUD() {
            const ranks = ["NEOPHYTE", "OBSERVER", "PATHFINDER", "ARCHITECT", "SOVEREIGN"];
            document.getElementById('rank').innerText = "LEVEL: " + ranks[Math.min(state.badges.length, 4)];
            document.getElementById('sector-label').innerText = `SECTOR ${state.currentIdx} | ${state.sectors[state.currentIdx].stars.length} STARS`;
            if (state.badges.length >= 3) document.getElementById('god-btn').classList.remove('hidden');
        }

        function jump(i) { document.getElementById('universe').style.transform = `translateX(-${i * 100}vw)`; }
        function toggleMap() { document.getElementById('universe').classList.toggle('map-view'); }
        function toggleGod() { document.body.classList.toggle('god-mode'); }
        function addLog(t) { const term = document.getElementById('terminal'), d = document.createElement('div'); d.innerText = `> ${t}`; term.appendChild(d); term.scrollTop = term.scrollHeight; }

        window.onload = render;
    </script>
</body>
</html>
