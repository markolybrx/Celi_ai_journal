<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icon.png">

    <title>Celi: AI Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW Fail:', err));
            });
        }
    </script>

    <style>
        :root { --mood: #00f2fe; --bg: #000; --glass: rgba(20, 20, 25, 0.6); --border: rgba(255, 255, 255, 0.08); --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #static-background { position: fixed; inset: 0; z-index: -1; background: var(--bg); transition: background 1s ease; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; color: #fff; font-family: var(--font); overflow: hidden; position: fixed; }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        #void-vignette { position: fixed; inset: 0; pointer-events: none; z-index: 90; background: radial-gradient(circle at center, transparent 30%, #000 100%); opacity: 0; transition: opacity 0.8s ease; }
        body.void-active #main-view, body.void-active .app-header { filter: grayscale(100%) blur(3px) brightness(0.5); transform: scale(0.95); transition: all 0.8s; }
        body.void-active #void-vignette { opacity: 1; }
        body.keyboard-active .bottom-dock, body.chat-open .bottom-dock, body.keyboard-active .fab-container, body.chat-open .fab-container, body.keyboard-active .void-container, body.chat-open .void-container { display: none !important; }
        #main-view { position: absolute; top: 60px; bottom: 0; left: 0; right: 0; overflow-y: auto; padding: 15px 20px 120px 20px; transition: all 0.5s ease; z-index: 10; }
        
        .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: rgba(10, 10, 15, 0.7); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 50; }
        .logo { font-size: 22px; font-weight: 900; letter-spacing: -1px; } .version-tag { font-size: 10px; opacity: 0.5; font-family: monospace; }
        .header-pfp { width: 36px; height: 36px; border-radius: 50%; background: #222; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); } .header-pfp img { width: 100%; height: 100%; object-fit: cover; }
        .search-trigger { cursor: pointer; opacity: 0.7; padding: 5px; } .search-bar-container { position: absolute; right: 45px; top: 50%; transform: translateY(-50%); width: 0; overflow: hidden; height: 36px; transition: width 0.4s, opacity 0.3s; background: rgba(0, 0, 0, 0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 18px; display: flex; align-items: center; opacity: 0; pointer-events: none; }
        .search-bar-container.active { width: 220px; opacity: 1; pointer-events: all; border-color: var(--mood); }
        .search-input { width: 100%; border: none; outline: none; color: #fff; font-size: 13px; padding: 0 15px; background: transparent; }

        .rank-card, .calendar-card { background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; backdrop-filter: blur(20px); }
        .rank-card { display: flex; align-items: center; gap: 12px; }
        .rank-icon { width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.03); border: 2px solid var(--mood); display: flex; align-items: center; justify-content: center; color: #fff; }
        .progress-bar { height: 3px; background: var(--mood); width: 0%; box-shadow: 0 0 5px var(--mood); transition: width 1s; }
        
        .cal-header { display: flex; justify-content: space-between; margin-bottom: 15px; } .cal-btn { width: 28px; height: 28px; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-size: 10px; }
        .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 6px; color: rgba(255,255,255,0.7); }
        .cal-day.today { background: rgba(255,255,255,0.1); color: #fff; font-weight: 900; border: 1px solid rgba(255,255,255,0.2); }
        .cal-day.has-entry { color: var(--mood); font-weight: bold; cursor: pointer; } .cal-day.has-entry::after { content: ''; width: 3px; height: 3px; background: var(--mood); border-radius: 50%; position: absolute; bottom: 3px; }

        .bottom-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; height: 75px; background: rgba(15, 15, 20, 0.85); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 40px; z-index: 30; display: flex; align-items: center; justify-content: space-evenly; transition: all 0.3s ease; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.4); background: none; border: none; width: 50px; gap: 4px; }
        .nav-btn span { font-size: 8px; font-weight: 600; text-transform: uppercase; }
        .nav-btn svg { width: 22px; height: 22px; }

        .galaxy-btn { width: 80px; height: 80px; border-radius: 50%; background: #fff; border: 4px solid rgba(255,255,255,0.1); color: #000; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 30px rgba(255, 255, 255, 0.4); transition: transform 0.4s, background-color 0.3s; margin: 0 5px; position: relative; z-index: 40; }
        .galaxy-btn svg { width: 50px; height: 50px; fill: none; transition: fill 0.3s; }
        .galaxy-btn:active { transform: scale(0.95); }
        .galaxy-btn.galaxy-open { background-color: #ef4444; border-color: #991b1b; transform: rotate(90deg) scale(1.1); box-shadow: 0 0 30px rgba(239, 68, 68, 0.5); }
        .galaxy-btn.galaxy-open svg { stroke: #fff; width: 36px; height: 36px; }

        .void-fab { width: 60px; height: 60px; border-radius: 50%; background: #000; display: flex; align-items: center; justify-content: center; animation: voidGlow 3s infinite alternate; }
        .chat-fab { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #f9a8d4, #c084fc); display: flex; align-items: center; justify-content: center; animation: pastelPulse 3s infinite; }
        .void-container { position: fixed; bottom: 110px; left: 25px; z-index: 40; } .fab-container { position: fixed; bottom: 110px; right: 25px; z-index: 40; }
        
        /* --- MORPHING CHAT ANIMATION --- */
        .chat-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; 
            display: none; align-items: center; justify-content: center; 
            backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.4s; 
        }
        .chat-overlay.active { display: flex; opacity: 1; }
        
        .chat-modal-window { 
            width: 90%; max-width: 500px; height: 80vh; background: #111; 
            border: 1px solid var(--border); border-radius: 25px; 
            display: flex; flex-direction: column; overflow: hidden; 
            /* Start state: Small and hidden */
            transform: scale(0); opacity: 0;
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.3s ease;
        }

        /* Origin: Bottom Left (From Void FAB) */
        .chat-modal-window.origin-void { transform-origin: bottom left; margin-left: 25px; margin-bottom: 110px; }
        
        /* Origin: Bottom Right (From Celi FAB) */
        .chat-modal-window.origin-ai { transform-origin: bottom right; margin-right: 25px; margin-bottom: 110px; }

        /* End state: Full size */
        .chat-overlay.active .chat-modal-window { transform: scale(1); opacity: 1; margin: 0; }

        .chat-overlay.void-mode .chat-modal-window { background: #000; box-shadow: 0 0 40px #000; }
        .chat-overlay.ai-mode .chat-modal-window { background: #222831; } /* Dark Blue-Grey for AI */
        
        .chat-header { height: 60px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border); }
        .chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        .msg { max-width: 85%; padding: 14px 18px; border-radius: 20px; font-size: 13.5px; animation: pop 0.4s forwards; opacity: 0; transform: scale(0.9); }
        @keyframes pop { to { opacity: 1; transform: scale(1); } }
        .msg-user { align-self: flex-end; background: var(--mood); color: #000; font-weight: 600; border-bottom-right-radius: 4px; }
        .msg-ai { align-self: flex-start; background: rgba(255,255,255,0.08); color: #eee; border-bottom-left-radius: 4px; }
        .input-area { padding: 15px; background: rgba(0,0,0,0.95); border-top: 1px solid var(--border); display: flex; align-items: center; }
        .chat-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 25px; padding: 12px 20px; color: #fff; outline: none; }

        .close-fab { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; border-radius: 50%; background: #ef4444; border: 1px solid #b91c1c; display: flex; align-items: center; justify-content: center; color: #fff; z-index: 100; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 110; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(8px); }
        .modal-box { background: #111; border: 1px solid var(--border); border-radius: 30px; width: 100%; max-width: 400px; padding: 30px; position: relative; }
        
        @keyframes voidGlow { from { box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); } to { box-shadow: 0 0 25px rgba(99, 102, 241, 0.6); } }
        @keyframes pastelPulse { 0% { box-shadow: 0 0 0 0 rgba(192, 132, 252, 0.6); } 100% { box-shadow: 0 0 0 15px rgba(192, 132, 252, 0); } }
        .spin-ccw { animation: spinCCW 8s linear infinite; transform-origin: center; } @keyframes spinCCW { to { transform: rotate(-360deg); } }
    </style>
</head>
<body>

    <div id="void-vignette"></div>
    <div id="static-background"></div>

    <div class="app-header">
        <div class="header-left"><div class="logo">Celi</div><div class="version-tag">v3.0.17</div></div>
        <div class="header-right"><div class="header-pfp" onclick="openModal('profile-modal')"><img id="nav-pfp" src=""></div></div>
    </div>

    <div id="main-view">
        <div class="rank-card" onclick="openModal('ranks-modal')">
            <div class="rank-icon" id="rank-icon-slot"></div>
            <div class="rank-details">
                <div id="greeting-text" class="greeting">Good Morning</div>
                <div id="rank-display" class="rank-title">Observer I</div>
                <div class="progress-container"><div id="rank-progress-bar" class="progress-bar"></div></div>
            </div>
        </div>
        <div class="calendar-card">
            <div class="cal-header"><button class="cal-btn" onclick="changeMonth(-1)">‹</button><div id="cal-month-year" class="cal-title">Loading...</div><button class="cal-btn" onclick="changeMonth(1)">›</button></div>
            <div class="cal-grid" id="cal-grid"></div>
        </div>
    </div>

    <div class="bottom-dock">
        <button class="nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg><span>Tasks</span></button>
        <button class="nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg><span>Trivias</span></button>
        <button id="galaxy-btn" class="galaxy-btn" onclick="toggleGalaxy()">
            <svg id="galaxy-icon-svg" viewBox="0 0 24 24"><g fill="currentColor" stroke="currentColor" stroke-width="0.8"><circle cx="12" cy="12" r="2.5" fill="black" stroke="none" /><path d="M12 12 C14.5 12 16 10 16 8 C16 6 14 5 12 5" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C12 14.5 14 16 16 16 C18 16 19 14 19 12" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C9.5 12 8 14 8 16 C8 18 10 19 12 19" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C12 9.5 10 8 8 8 C6 8 5 10 5 12" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><circle cx="8" cy="8" r="0.5" fill="black" stroke="none" /><circle cx="16" cy="16" r="0.5" fill="black" stroke="none" /><circle cx="16" cy="8" r="0.5" fill="black" stroke="none" /><circle cx="8" cy="16" r="0.5" fill="black" stroke="none" /></g></svg>
        </button>
        <button class="nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg><span>Neural</span></button>
        <button class="nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span>Gallery</span></button>
    </div>

    <div class="void-container" onclick="openChat('rant')"><div class="void-fab"><svg width="44" height="44" viewBox="0 0 24 24" fill="none"><defs><linearGradient id="voidGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#facc15" /><stop offset="40%" stop-color="#f97316" /><stop offset="100%" stop-color="#9333ea" /></linearGradient></defs><circle cx="12" cy="12" r="11" fill="url(#voidGradient)" class="spin-ccw" /><circle cx="12" cy="12" r="5" fill="black" /></svg></div></div>
    <div class="fab-container" onclick="openChat('journal')"><div class="chat-fab"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><g transform="rotate(-90 12 12)"><path d="M12 19l7-7 3 3-7 7-3-3z" /><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" /><path d="M2 2l7.586 7.586" /><circle cx="11" cy="11" r="2" fill="white" stroke="none" opacity="0.6"/><path d="M19 0 L20.5 3.5 L24 5 L20.5 6.5 L19 10 L17.5 6.5 L14 5 L17.5 3.5 Z" fill="white" stroke="none"/></g></svg></div></div>

    <div id="chat-overlay" class="chat-overlay" onclick="handleOutsideClick(event)">
        <div id="chat-modal-window" class="chat-modal-window" onclick="handleWindowClick(event)">
            <div class="chat-header">
                <span id="chat-header-title" class="font-bold tracking-widest text-sm uppercase">Celi Neural Link</span>
                <div class="chat-controls"><div class="win-btn" onclick="toggleDock(event)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg></div><div class="win-btn" onclick="closeChat(event)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div></div>
            </div>
            <div id="chat-history" class="chat-history"></div>
            <div class="input-area"><input type="text" id="chat-input" class="chat-input" placeholder="Transmit signal..." onkeypress="handleEnter(event)"><button onclick="sendMessage()" class="send-btn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button></div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="close-fab" onclick="closeModal('profile-modal')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
            <div class="pfp-large"><img id="profile-pfp" class="pfp-img" src=""></div>
            <div class="profile-info"><h2 id="profile-username" class="text-2xl font-bold tracking-tight">User</h2><div id="profile-rank-badge" class="inline-block px-4 py-1 mt-2 text-[10px] uppercase font-bold tracking-widest bg-white/10 rounded-full text-[var(--mood)]">Observer</div><p id="profile-id" class="text-[10px] opacity-40 mt-3 font-mono tracking-widest">ID: 000000</p></div><div class="bg-white/5 p-5 rounded-2xl mb-6 border border-white/5"><h3 class="text-[9px] uppercase tracking-[2px] text-cyan-400 mb-3 font-bold opacity-80">Soul Analysis</h3><p id="soul-analysis" class="text-xs text-gray-300 leading-relaxed italic opacity-90">"No data."</p></div><button onclick="doLogout()" class="w-full py-4 bg-red-500/10 border border-red-500/30 text-red-400 rounded-xl text-[10px] font-bold uppercase tracking-widest">Disconnect</button>
        </div>
    </div>

    <div id="ranks-modal" class="modal-overlay">
        <div class="modal-box" style="max-height: 80vh;">
            <div class="close-fab" onclick="closeModal('ranks-modal')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
            <h2 class="text-xl font-bold text-center mb-6 tracking-wide text-white">Constellation Path</h2><div id="ranks-grid" class="flex flex-col gap-3 overflow-y-auto pr-2"></div>
        </div>
    </div>

    <script>
        let isProcessing = false; let currentCalendarDate = new Date(); let fullChatHistory = {}; let userHistoryDates = []; let currentMode = 'journal'; let isDocked = false;

        document.addEventListener('focusin', function(e) { if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') document.body.classList.add('keyboard-active'); });
        document.addEventListener('focusout', function(e) { if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') document.body.classList.remove('keyboard-active'); });

        function showToast(msg) { console.log(msg); const btn = event.currentTarget; if(btn) { btn.style.color = "var(--mood)"; setTimeout(() => { btn.style.color = "rgba(255,255,255,0.4)"; }, 500); } }

        function toggleGalaxy() {
            const btn = document.getElementById('galaxy-btn');
            const isOpen = btn.classList.contains('galaxy-open');
            if (!isOpen) {
                btn.classList.add('galaxy-open');
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width:36px; height:36px;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                document.body.classList.add('galaxy-active');
            } else {
                btn.classList.remove('galaxy-open');
                btn.innerHTML = `<svg id="galaxy-icon-svg" viewBox="0 0 24 24"><g fill="currentColor" stroke="currentColor" stroke-width="0.8"><circle cx="12" cy="12" r="2.5" fill="black" stroke="none" /><path d="M12 12 C14.5 12 16 10 16 8 C16 6 14 5 12 5" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C12 14.5 14 16 16 16 C18 16 19 14 19 12" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C9.5 12 8 14 8 16 C8 18 10 19 12 19" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><path d="M12 12 C12 9.5 10 8 8 8 C6 8 5 10 5 12" fill="none" stroke-linecap="round" stroke-dasharray="1 1" /><circle cx="8" cy="8" r="0.5" fill="black" stroke="none" /><circle cx="16" cy="16" r="0.5" fill="black" stroke="none" /><circle cx="16" cy="8" r="0.5" fill="black" stroke="none" /><circle cx="8" cy="16" r="0.5" fill="black" stroke="none" /></g></svg>`;
                document.body.classList.remove('galaxy-active');
            }
        }

        const rankIcons = {
            "Observer": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/><path d="M12 5v2"/><path d="M12 17v2"/><path d="M5 12h2"/><path d="M17 12h2"/><path d="M12 9a3 3 0 0 1 0 6"/><path d="M12 10a2 2 0 0 1 0 4"/></svg>',
            "Moonwalker": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M8 12a3 3 0 1 0 6 0 3 3 0 1 0-6 0"/><path d="M15 8a2 2 0 1 0-4 0 2 2 0 1 0 4 0"/><path d="M10 16a2 2 0 1 0 4 0"/><path d="M12 21v-4"/><path d="M12 3v2"/></svg>',
            "Celestial": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="6"/><path d="M3.5 13.5c1.5-3.5 8-5 13.5-3.5s7.5 6 6 7.5"/><path d="M4 12a14 6 0 0 1 16-2"/><path d="M7 12a1 1 0 1 0 2 0 1 1 0 1 0-2 0"/><path d="M16 10a1 1 0 1 0 0 2 1 1 0 1 0 0-2"/></svg>',
            "Stellar": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v3"/><path d="M12 19v3"/><path d="M2 12h3"/><path d="M19 12h3"/><path d="M4.93 4.93l2.12 2.12"/><path d="M16.95 16.95l2.12 2.12"/><path d="M4.93 19.07l2.12-2.12"/><path d="M16.95 7.05l2.12-2.12"/><path d="M12 9a3 3 0 0 1 0 6"/></svg>',
            "Interstellar": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="5" cy="5" r="2"/><circle cx="19" cy="5" r="2"/><circle cx="19" cy="19" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="12" r="1"/><line x1="7" y1="7" x2="11" y2="11"/><line x1="17" y1="7" x2="13" y2="11"/><line x1="7" y1="17" x2="11" y2="13"/><line x1="17" y1="17" x2="13" y2="13"/><path d="M5 7v10"/><path d="M7 5h10"/><path d="M19 7v10"/><path d="M7 19h10"/></svg>',
            "Galactic": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 12c-3-3-3-9 0-11 3-2 9-2 11 0"/><path d="M12 12c3 3 3 9 0 11-3 2-9 2-11 0"/><path d="M12 12c-3 3-9 3-11 0-2-3-2-9 0-11"/><path d="M12 12c3-3 9-3 11 0 2 3 2 9 0 11"/><circle cx="12" cy="12" r="1.5"/><circle cx="6" cy="18" r="0.5"/><circle cx="18" cy="6" r="0.5"/></svg>',
            "Ethereal": '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="8" width="8" height="8" rx="1"/><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M8 8L3 3"/><path d="M16 8l5-5"/><path d="M8 16l-5 5"/><path d="M16 16l5 5"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>'
        };

        function getRankColor(rankName) {
            if(rankName.includes("Observer") || rankName.includes("Moonwalker")) return "#00f2fe"; 
            if(rankName.includes("Celestial") || rankName.includes("Stellar")) return "#facc15"; 
            if(rankName.includes("Interstellar") || rankName.includes("Galactic")) return "#a855f7"; 
            if(rankName.includes("Ethereal")) return "#ffffff"; 
            return "#00f2fe";
        }

        document.addEventListener('click', function(e) { const container = document.getElementById('search-container'); const trigger = document.getElementById('search-trigger'); if (!container.contains(e.target) && !trigger.contains(e.target)) { container.classList.remove('active'); document.getElementById('search-input').value = ''; } });
        function toggleSearch() { const container = document.getElementById('search-container'); const input = document.getElementById('search-input'); container.classList.toggle('active'); if(container.classList.contains('active')) input.focus(); else { input.value = ''; resetChatFilter(); } }
        function handleSearch() { const query = document.getElementById('search-input').value.toLowerCase(); if(query.length < 2) { resetChatFilter(); return; } const filtered = {}; let found = false; Object.keys(fullChatHistory).forEach(key => { const entry = fullChatHistory[key]; if((entry.summary && entry.summary.toLowerCase().includes(query)) || (entry.reply && entry.reply.toLowerCase().includes(query))) { filtered[key] = entry; found = true; } }); if(found) { renderChatHistory(filtered); if(document.getElementById('chat-overlay').style.display === 'none') openChat('ai'); document.getElementById('chat-header-title').innerText = "SEARCH RESULTS"; } }
        function resetChatFilter() { renderChatHistory(fullChatHistory); document.getElementById('chat-header-title').innerText = currentMode === 'rant' ? "THE VOID" : "CELI NEURAL LINK"; }
        
        function openChat(mode) { 
            currentMode = mode; 
            const overlay = document.getElementById('chat-overlay'); 
            const title = document.getElementById('chat-header-title'); 
            const modalWindow = document.getElementById('chat-modal-window'); // Get the inner window
            
            isDocked = false; 
            overlay.classList.remove('docked'); 
            
            // --- ANIMATION ORIGIN LOGIC ---
            // Reset classes
            modalWindow.classList.remove('origin-void', 'origin-ai');
            
            if(mode === 'rant') { 
                modalWindow.classList.add('origin-void'); // Animate from Left
                overlay.classList.add('void-mode'); 
                title.innerText = "THE VOID"; 
                document.body.classList.add('void-active'); 
            } else { 
                modalWindow.classList.add('origin-ai'); // Animate from Right
                overlay.classList.remove('void-mode'); 
                title.innerText = "CELI NEURAL LINK"; 
                document.body.classList.remove('void-active'); 
            } 
            
            document.body.classList.add('chat-open'); 
            overlay.classList.add('active'); 
            
            const c = document.getElementById('chat-history'); c.scrollTop = c.scrollHeight; 
            document.getElementById('chat-input').focus(); 
            renderChatHistory(fullChatHistory);
        }

        function toggleDock(e) { e.stopPropagation(); const overlay = document.getElementById('chat-overlay'); isDocked = !isDocked; if(isDocked) { overlay.classList.add('docked'); document.body.classList.remove('void-active'); document.body.classList.remove('chat-open'); } else { overlay.classList.remove('docked'); if(currentMode === 'rant') document.body.classList.add('void-active'); document.body.classList.add('chat-open'); } }
        function handleWindowClick(e) { e.stopPropagation(); if(isDocked) toggleDock(e); }
        function closeChat(e) { if(e) e.stopPropagation(); const overlay = document.getElementById('chat-overlay'); overlay.classList.remove('active'); overlay.classList.remove('docked'); isDocked = false; document.body.classList.remove('void-active'); document.body.classList.remove('chat-open'); }
        function handleOutsideClick(e) { if(e.target.id === 'chat-overlay') closeChat(); }
        
        function renderChatHistory(historyData) { 
            const container = document.getElementById('chat-history'); 
            container.innerHTML = ''; 
            const sortedKeys = Object.keys(historyData).sort((a, b) => parseFloat(a) - parseFloat(b)); 
            const recentKeys = sortedKeys.slice(-50); 
            const fragment = document.createDocumentFragment(); 
            
            recentKeys.forEach(timestamp => { 
                const entry = historyData[timestamp]; 
                fragment.appendChild(createMsgEl(entry.summary || "Entry", 'user')); 
                fragment.appendChild(createMsgEl(entry.reply, 'ai')); 
            }); 
            
            container.appendChild(fragment); 
            
            // CONTEXTUAL GREETING ON OPEN
            if(recentKeys.length === 0) {
                let greeting = "";
                if (currentMode === 'rant') {
                    greeting = "Void Link Established. This space is for ranting.";
                } else {
                    greeting = "Journal Link Established. How is your day going?";
                }
                container.appendChild(createMsgEl(greeting, 'ai')); 
            }
            
            requestAnimationFrame(() => container.scrollTop = container.scrollHeight); 
        }

        function renderCalendar() { const grid = document.getElementById('cal-grid'); if(!grid) return; grid.innerHTML = ''; const year = currentCalendarDate.getFullYear(); const month = currentCalendarDate.getMonth(); const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"]; document.getElementById('cal-month-year').innerText = `${monthNames[month]} ${year}`; ["S","M","T","W","T","F","S"].forEach(d => { const el = document.createElement('div'); el.className = 'cal-day-label'; el.innerText = d; grid.appendChild(el); }); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); for(let i=0; i<firstDay; i++) { grid.appendChild(document.createElement('div')); } const today = new Date(); for(let i=1; i<=daysInMonth; i++) { const el = document.createElement('div'); el.className = 'cal-day'; el.innerText = i; if(i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) el.classList.add('today'); const checkDate = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; if(userHistoryDates.includes(checkDate)) { el.classList.add('has-entry'); el.onclick = () => filterChatByDate(checkDate); } grid.appendChild(el); } }
        function changeMonth(dir) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + dir); renderCalendar(); }
        function filterChatByDate(dateStr) { const filtered = {}; let found = false; Object.keys(fullChatHistory).forEach(key => { if(fullChatHistory[key].date === dateStr) { filtered[key] = fullChatHistory[key]; found = true; } }); renderChatHistory(filtered); openChat('ai'); document.getElementById('chat-header-title').innerText = `ARCHIVE: ${dateStr}`; }
        
        function renderAllRanks() { 
            const list = ["Observer", "Moonwalker", "Celestial", "Stellar", "Interstellar", "Galactic", "Ethereal"]; 
            const container = document.getElementById('ranks-grid'); 
            container.innerHTML = ''; 
            list.forEach(r => { 
                const color = getRankColor(r); 
                const icon = rankIcons[r] || rankIcons["Observer"]; // Fallback
                const div = document.createElement('div'); 
                div.className = "flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/5 transition hover:bg-white/10"; 
                div.innerHTML = `<div class="w-14 h-14 rounded-full flex items-center justify-center bg-white/5 border-2 shadow-lg" style="border-color:${color}; box-shadow: 0 0 15px ${color}, inset 0 0 10px rgba(255,255,255,0.1); color: white;">${icon}</div><div><div class="text-xs font-bold uppercase tracking-[2px]" style="color: ${color}">${r}</div><div class="text-[9px] text-white/40 mt-1 uppercase tracking-wider">Phase Lock</div></div>`; 
                container.appendChild(div); 
            }); 
        }
        
        async function loadData() { 
            try { 
                const res = await fetch('/api/data'); 
                const data = await res.json(); 
                if(data.status === 'guest') { window.location.href = '/login'; return; } 
                
                document.getElementById('greeting-text').innerText = `Good Day, ${data.first_name || 'Traveler'}!`; 
                document.getElementById('rank-display').innerText = data.rank; 
                document.getElementById('rank-progress-bar').style.width = `${data.rank_progress}%`; 
                
                const baseRank = data.rank.split(' ')[0]; 
                document.documentElement.style.setProperty('--mood', getRankColor(baseRank)); 
                document.getElementById('rank-icon-slot').innerHTML = rankIcons[baseRank] || rankIcons["Observer"]; 
                
                if(data.history) { 
                    fullChatHistory = data.history; 
                    userHistoryDates = Object.values(data.history).map(entry => entry.date); 
                    renderCalendar(); 
                    renderChatHistory(fullChatHistory); 
                } 
            } catch(e) { 
                console.log("Sync error", e); 
            } 
        }

        async function sendMessage() { 
            if(isProcessing) return; 
            const input = document.getElementById('chat-input'); 
            const msg = input.value.trim(); 
            if(!msg) return; 
            
            appendMsg(msg, 'user'); 
            input.value = ''; input.focus(); isProcessing = true; 
            const typingId = 'typing-' + Date.now(); 
            appendTyping(typingId); 
            
            const mode = currentMode === 'rant' ? 'rant' : 'journal'; 
            
            try { 
                const res = await fetch('/api/process', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ message: msg, mode: mode }) 
                }); 
                removeMsg(typingId); 
                
                if (!res.ok) throw new Error(`Server Error: ${res.status}`);
                
                const data = await res.json(); 
                appendMsg(data.reply, 'ai'); 
                
                // HANDLE AUTO-SWITCH COMMAND FROM BACKEND
                if (data.command === "switch_to_void") {
                    setTimeout(() => {
                        openChat('rant');
                    }, 1000); // 1s delay for effect
                }

                await loadData(); 
            } catch(e) { 
                removeMsg(typingId); 
                appendMsg(`Error: ${e.message}. Tap to retry.`, 'ai'); 
            } 
            isProcessing = false; 
        }

        function parseMarkdown(text) { let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); return html; }
        function createMsgEl(text, sender) { const div = document.createElement('div'); div.className = `msg msg-${sender}`; if (sender === 'ai') div.innerHTML = parseMarkdown(text); else div.innerText = text; return div; }
        function appendMsg(text, sender) { const container = document.getElementById('chat-history'); container.appendChild(createMsgEl(text, sender)); container.scrollTop = container.scrollHeight; }
        function appendTyping(id) { const div = document.createElement('div'); div.id = id; div.className = 'msg msg-ai pulse'; div.innerText = '...'; const c = document.getElementById('chat-history'); c.appendChild(div); c.scrollTop = c.scrollHeight; }
        function removeMsg(id) { const el = document.getElementById(id); if(el) el.remove(); }
        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function doLogout() { window.location.href = '/logout'; }

        window.onload = loadData;
    </script>
</body>
</html>
