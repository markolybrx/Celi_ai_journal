<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Celi | Sovereign Mirror</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --accent: #6366f1;
            --deep-space: #050508;
        }
        body { 
            background: var(--deep-space); color: #f8fafc; font-family: 'Inter', sans-serif;
            height: 100dvh; overflow: hidden; margin: 0;
            padding: var(--safe-top) 20px var(--safe-bottom) 20px;
        }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .lens { width: 220px; height: 220px; border-radius: 50%; margin: 40px auto; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        .chat-panel { 
            position: fixed; bottom: 12px; left: 12px; right: 12px; height: 85dvh; border-radius: 32px;
            transform: translateY(110%); transition: 0.7s cubic-bezier(0.19, 1, 0.22, 1); z-index: 100; display: flex; flex-direction: column; padding: 24px;
        }
        .chat-open { transform: translateY(0); }
        .msg { max-width: 85%; padding: 16px 20px; border-radius: 24px; font-size: 15px; margin-bottom: 12px; }
        .msg-celi { background: rgba(255, 255, 255, 0.05); align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg-user { background: var(--accent); align-self: flex-end; border-bottom-right-radius: 4px; }
        input { background: rgba(255,255,255,0.05)!important; border: 1px solid rgba(255,255,255,0.1)!important; color: #fff!important; padding: 16px; border-radius: 18px; width: 100%; outline: none; }
        #setup-overlay { position: fixed; inset: 0; background: var(--deep-space); z-index: 200; padding: 40px 20px; }
        .primary-btn { background: var(--accent); color: white; padding: 18px; border-radius: 20px; font-weight: 600; width: 100%; }
        .star { position: absolute; background: #fff; border-radius: 50%; opacity: 0.5; }
    </style>
</head>
<body class="flex flex-col">

    <div id="setup-overlay" class="flex flex-col">
        <h1 class="text-[10px] font-bold tracking-[0.8em] text-slate-500 uppercase text-center mt-10">Celi Identity</h1>
        <div id="reg-chat" class="flex-grow overflow-y-auto flex flex-col justify-end pb-10">
            <div class="msg msg-celi">The mirror is dark. Connect your vault or start a new genesis.</div>
        </div>
        <div id="initial-choice" class="flex gap-4">
            <button onclick="startRegChat()" class="primary-btn">New Genesis</button>
            <button onclick="initFile(false)" class="glass p-4 rounded-[20px] text-sm flex-grow">Restore</button>
        </div>
        <div id="reg-input-area" class="hidden flex gap-2">
            <div id="input-wrapper" class="flex-grow"></div>
            <button onclick="handleRegInput()" class="bg-indigo-600 px-6 rounded-2xl">OK</button>
        </div>
    </div>

    <header class="flex justify-between items-center pt-4">
        <p id="header-id" class="text-[10px] font-bold text-slate-500">ID: ---</p>
        <button onclick="toggleModal('vault-modal')" class="text-[10px] font-bold text-slate-400">VAULT</button>
    </header>

    <div class="lens" id="galaxy"></div>

    <div class="mt-auto mb-10">
        <p id="greeting" class="text-sm text-slate-400 text-center mb-8 italic px-10"></p>
        <button onclick="toggleChat()" class="primary-btn">Initialize Dialogue</button>
    </div>

    <div id="chat-panel" class="chat-panel glass">
        <div class="flex justify-between mb-4"><span class="text-[10px] font-bold text-slate-500 uppercase">Neural Stream</span><button onclick="toggleChat()">Minimize</button></div>
        <div id="chat-box" class="flex-grow overflow-y-auto space-y-4 pr-2 flex flex-col"></div>
        <div id="typing" class="hidden text-[10px] text-indigo-400 animate-pulse ml-2 mb-2">CELI IS THINKING...</div>
        <div class="flex gap-2">
            <input id="user-input" placeholder="Speak..." onkeydown="if(event.key==='Enter') sendMsg()">
            <button onclick="sendMsg()" class="bg-indigo-600 px-4 rounded-xl text-[10px] font-bold">SEND</button>
        </div>
    </div>

    <div id="vault-modal" class="hidden glass fixed inset-4 rounded-[32px] z-[150] p-8 flex flex-col">
        <div class="flex justify-between mb-8 pb-4 border-b border-white/5">
            <h2 class="text-xs font-bold uppercase">Sovereign Core</h2>
            <button onclick="toggleModal('vault-modal')">CLOSE</button>
        </div>
        <div class="bg-white/5 p-4 rounded-2xl mb-6">
            <p class="text-[9px] text-slate-500 uppercase mb-2">Latest Insight</p>
            <p id="vault-insight" class="text-sm italic text-slate-300"></p>
        </div>
        <div class="space-y-4">
            <input id="p-name" placeholder="Name">
            <input id="p-color" placeholder="Hex Color">
            <button onclick="updateProfile()" class="primary-btn">Update</button>
        </div>
        <button onclick="wipeData()" class="mt-auto text-red-900 text-[10px] font-bold uppercase opacity-20">Purge</button>
    </div>

    <script>
        let fileHandle;
        let LOCAL_DB = { profile: {}, entries: [], insights: [] };
        let regStep = 0;
        const questions = [{k:"uid",q:"User ID?"},{k:"pw",q:"Password?"},{k:"pwc",q:"Confirm?"},{k:"name",q:"Name?"},{k:"bday",q:"Birthday?"},{k:"color",q:"Hex Color?"}];

        function startRegChat() { document.getElementById('initial-choice').classList.add('hidden'); document.getElementById('reg-input-area').classList.remove('hidden'); askNextReg(); }
        function askNextReg() { const q = questions[regStep]; addRegMsg(q.q, 'celi'); document.getElementById('input-wrapper').innerHTML = `<input id="reg-field" type="${q.k.includes('pw')?'password':'text'}" autofocus onkeydown="if(event.key==='Enter') handleRegInput()">`; }
        function addRegMsg(t, s) { const b = document.getElementById('reg-chat'); const d = document.createElement('div'); d.className = `msg msg-${s}`; d.innerText = t; b.appendChild(d); b.scrollTop = b.scrollHeight; }

        async function handleRegInput() {
            const i = document.getElementById('reg-field'); const v = i.value.trim(); if(!v) return;
            LOCAL_DB.profile[questions[regStep].k] = v;
            regStep++; addRegMsg(v, 'user'); i.value = '';
            if(regStep < questions.length) setTimeout(askNextReg, 400);
            else { addRegMsg("Linking Vault...", 'celi'); setTimeout(() => initFile(true), 800); }
        }

        async function initFile(isNew) {
            try {
                if(isNew) {
                    fileHandle = await window.showSaveFilePicker({ suggestedName: 'celi_vault.json' });
                    const w = await fileHandle.createWritable(); await w.write(JSON.stringify(LOCAL_DB)); await w.close();
                } else {
                    [fileHandle] = await window.showOpenFilePicker();
                    LOCAL_DB = JSON.parse(await (await fileHandle.getFile()).text());
                }
                document.getElementById('setup-overlay').style.display = 'none';
                loadDashboard();
            } catch(e) { alert("File Access Required. Use HTTPS."); }
        }

        function loadDashboard() {
            document.getElementById('header-id').innerText = `ID: ${LOCAL_DB.profile.uid}`;
            document.getElementById('greeting').innerText = `Trajectory active, ${LOCAL_DB.profile.name}. Ready for audit?`;
            document.documentElement.style.setProperty('--accent', LOCAL_DB.profile.color || '#6366f1');
            updateGalaxy();
        }

        async function sendMsg() {
            const i = document.getElementById('user-input'); const val = i.value.trim(); if(!val) return;
            addChat("YOU", val, 'msg-user'); i.value = '';
            document.getElementById('typing').classList.remove('hidden');
            try {
                const r = await fetch('/api/process', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ message: val, profile: LOCAL_DB.profile, history: LOCAL_DB.entries.slice(-5).map(e=>e.text) }) 
                });
                const d = await r.json();
                document.getElementById('typing').classList.add('hidden');
                addChat("CELI", d.reply, 'msg-celi');
                if(d.insight) { document.getElementById('vault-insight').innerText = d.insight; LOCAL_DB.insights.push(d.insight); }
                LOCAL_DB.entries.push({text: val, date: new Date().toISOString()});
                saveToDisk();
            } catch(e) { document.getElementById('typing').classList.add('hidden'); alert("Handshake Failed. Check Render logs."); }
        }

        function addChat(s,t,c) { const b = document.getElementById('chat-box'); const d = document.createElement('div'); d.className = `msg ${c}`; d.innerText = t; b.appendChild(d); b.scrollTop = b.scrollHeight; }
        function saveToDisk() { if(fileHandle) { fileHandle.createWritable().then(w => { w.write(JSON.stringify(LOCAL_DB)); w.close(); }); } }
        function toggleChat() { document.getElementById('chat-panel').classList.toggle('chat-open'); }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function updateGalaxy() {
            const g = document.getElementById('galaxy'); g.innerHTML = '';
            for(let i=0; i<20; i++) {
                const s = document.createElement('div'); s.className = 'star';
                s.style.width = '2px'; s.style.height = '2px';
                s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
                g.appendChild(s);
            }
        }
    </script>
</body>
</html>
