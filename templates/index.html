<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Celi Sovereign</title>
    <link rel="manifest" href="/static/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mood: #00f2fe; --core: #ffd700; --warn: #6b7280; }
        body { background: #000; color: #fff; overflow: hidden; font-family: sans-serif; margin: 0; }
        
        #trivia-whisper {
            position: fixed; bottom: 140px; right: 105px; width: 240px;
            background: rgba(10, 10, 10, 0.95); border-radius: 24px 24px 0 24px;
            padding: 20px; font-size: 11px; display: none; z-index: 4500; backdrop-filter: blur(20px);
        }
        .whisper-blue { border: 1px solid var(--mood); color: var(--mood); box-shadow: 0 0 15px rgba(0, 242, 254, 0.2); }
        .whisper-gray { border: 1px solid var(--warn); color: var(--warn); opacity: 0.9; }

        .overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; padding: 120px 25px 100px; }
        .nav-btn { font-size: 8px; font-weight: 900; text-transform: uppercase; opacity: 0.3; }
        .active-btn { opacity: 1; color: var(--mood); }
    </style>
</head>
<body>
    <header class="fixed top-0 w-full z-[3000] p-10 flex justify-between items-center bg-gradient-to-b from-black to-transparent">
        <div class="w-10 h-10 border border-white/20 rounded-xl flex items-center justify-center" onclick="showTab('profile')">
            <div class="w-3 h-3 border border-white rotate-45"></div>
        </div>
        <p id="rank-display" class="text-[10px] font-black uppercase text-cyan-400">Observer III</p>
    </header>

    <main id="galaxy-container" class="fixed inset-0 overflow-hidden" onclick="checkLockAwareness(event)"></main>

    <div id="trivia-whisper">
        <p id="whisper-text">---</p>
    </div>

    <nav class="fixed bottom-10 left-1/2 -translate-x-1/2 w-[92%] h-[75px] rounded-[38px] bg-white/5 backdrop-blur-3xl flex items-center justify-around z-[4000] border border-white/10">
        <div onclick="showTab('vault')" class="nav-btn">Vault</div>
        <div onclick="showTab('archive')" class="nav-btn">Archive</div>
        <div onclick="showIntent()" class="w-12 h-12 bg-white rounded-full flex items-center justify-center"><div class="w-4 h-0.5 bg-black"></div></div>
        <div onclick="closeUI()" class="nav-btn active-btn">Galaxy</div>
        <div onclick="showTab('profile')" class="nav-btn">Profile</div>
    </nav>

    <div id="archive-overlay" class="overlay"><h2 class="text-3xl font-black mb-8 uppercase">Archive</h2><div id="archive-list" class="space-y-4"></div><button onclick="closeUI()" class="mt-auto py-10 opacity-20 text-[10px] uppercase">Back</button></div>

    <script>
        let cachedData = {};

        function whisper(msg, type) {
            const w = document.getElementById('trivia-whisper');
            w.className = type === 'trivia' ? 'whisper-blue' : 'whisper-gray';
            document.getElementById('whisper-text').innerText = msg;
            w.style.display = 'block';
            setTimeout(() => { w.style.display = 'none'; }, 6000);
        }

        function checkLockAwareness(e) {
            const currentPoints = cachedData.points;
            const nextRank = cachedData.rank_config.find(r => r.threshold > currentPoints);
            if (nextRank) {
                const diff = nextRank.threshold - currentPoints;
                whisper(`Access restricted. Reach ${nextRank.name} to view this nebula. (${diff} stars remaining)`, 'rank');
            }
        }

        async function triggerTrivia() {
            const r = await fetch(`/api/trivia?rank=${document.getElementById('rank-display').innerText.split(' ')[0]}`);
            const d = await r.json();
            whisper(d.trivia, 'trivia');
        }

        async function sync() {
            const r = await fetch('/api/data'); const d = await r.json(); cachedData = d;
            document.getElementById('rank-display').innerText = d.rank || "Observer III";
            const archiveList = document.getElementById('archive-list');
            archiveList.innerHTML = d.unlocked_trivias.map(t => `<div class="p-6 bg-white/5 rounded-2xl border border-white/5 text-sm">${t}</div>`).join('');
        }

        function showTab(t) { closeUI(); document.getElementById(t+'-overlay').style.display = 'flex'; sync(); }
        function closeUI() { document.querySelectorAll('.overlay').forEach(e => e.style.display = 'none'); }
        function showIntent() { document.getElementById('intent-modal').style.display = 'flex'; }

        window.onload = () => { sync(); setTimeout(triggerTrivia, 3000); setInterval(triggerTrivia, 300000); };
    </script>
</body>
</html>
