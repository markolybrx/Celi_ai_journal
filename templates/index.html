<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Celi Sovereign</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/image.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mood: #00f2fe; --core: #ffd700; --warn: #6b7280; --void: #8b5cf6; --singularity: #ffffff; }
        html, body { background: #000; color: #fff; overflow: hidden; height: 100%; width: 100%; font-family: sans-serif; margin: 0; touch-action: none; }
        
        .star-four-point { width: 12px; height: 12px; background: currentColor; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); box-shadow: 0 0 10px currentColor; }
        #trivia-whisper { position: fixed; bottom: 140px; right: 105px; width: 240px; background: rgba(10, 10, 10, 0.95); border-radius: 24px 24px 0 24px; padding: 20px; font-size: 11px; display: none; z-index: 4500; backdrop-filter: blur(20px); }
        .whisper-blue { border: 1px solid var(--mood); color: var(--mood); box-shadow: 0 0 15px rgba(0, 242, 254, 0.2); }
        .overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; padding: 0; }
        .portal-content { padding: 80px 25px 120px; overflow-y: auto; height: 100%; display: flex; flex-direction: column; align-items: center; }
        .card-glass { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 20px; margin-bottom: 12px; }
        .click-safe { pointer-events: auto !important; cursor: pointer; }
        .nav-btn { font-size: 8px; font-weight: 900; text-transform: uppercase; opacity: 0.3; transition: 0.3s; pointer-events: auto; }
        .active-btn { opacity: 1; color: var(--mood); }
        .close-btn-red { width: 48px; height: 48px; border-radius: 50%; background: rgba(220, 38, 38, 0.2); border: 1px solid rgba(220, 38, 38, 0.5); display: flex; align-items: center; justify-content: center; color: rgba(220, 38, 38, 0.8); margin-top: auto; margin-bottom: 20px; pointer-events: auto; }
        .profile-img-header, .profile-img-portal { width: 100%; height: 100%; object-fit: cover; }
        .profile-img-header { border-radius: 12px; } .profile-img-portal { border-radius: 50%; }
        #debug-status { opacity: 0.4; font-size: 9px; position: fixed; bottom: 30px; width: 100%; text-align: center; pointer-events: none; color: #00f2fe; }
    </style>
</head>
<body>

    <header class="fixed top-0 w-full z-[3000] px-6 py-4 bg-white/5 backdrop-blur-md border-b border-white/5 shadow-lg pointer-events-none">
        <div class="flex justify-between items-center h-full pointer-events-auto">
            <div class="flex flex-col justify-center gap-1.5 cursor-pointer active:opacity-60 click-safe" onclick="showTab('rank-portal')">
                <h1 id="greeting" class="text-xl font-bold tracking-tight text-white/90 leading-none">Connecting...</h1>
                <div class="flex items-center gap-3">
                    <div id="mini-rank-logo" class="w-8 h-8 rounded-full flex items-center justify-center bg-black/40 rank-ring-glow"></div>
                    <div class="flex flex-col justify-center w-24">
                        <p id="rank-display" class="text-[10px] font-black text-cyan-400 tracking-widest uppercase leading-none mb-1 truncate">---</p>
                        <div class="w-full h-1 bg-white/10 rounded-full overflow-hidden"><div id="rank-bar" class="h-full bg-cyan-400 transition-all duration-1000 ease-out" style="width: 0%"></div></div>
                    </div>
                </div>
            </div>
            <div onclick="showTab('profile')" class="w-12 h-12 bg-white/5 border border-white/10 rounded-2xl flex items-center justify-center cursor-pointer hover:bg-white/10 transition click-safe overflow-hidden">
                <div id="header-profile-container" class="w-full h-full flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                </div>
            </div>
        </div>
    </header>

    <main id="galaxy-container" class="fixed inset-0 overflow-hidden pointer-events-auto" onclick="triggerRipple(event)"></main>
    <div id="trivia-whisper"><p id="whisper-text">---</p></div>

    <nav class="fixed bottom-10 left-1/2 -translate-x-1/2 w-[92%] h-[75px] rounded-[38px] bg-white/5 backdrop-blur-3xl flex items-center justify-around z-[4000] border border-white/10 pointer-events-auto">
        <div onclick="showTab('vault')" class="nav-btn click-safe">Vault</div><div onclick="showTab('archive')" class="nav-btn click-safe">Archive</div>
        <div onclick="showIntent()" class="w-12 h-12 bg-white rounded-full flex items-center justify-center cursor-pointer click-safe"><div class="w-4 h-0.5 bg-black"></div></div>
        <div onclick="closeUI()" class="nav-btn active-btn click-safe">Galaxy</div><div onclick="showTab('profile')" class="nav-btn click-safe">Profile</div>
    </nav>
    <div class="fixed bottom-2 w-full text-center z-[5000] pointer-events-none opacity-30 text-[8px] font-mono tracking-widest text-white">celi_ai v1.2.0 (Gemini)</div>
    <div id="debug-status">Waiting for uplink...</div>

    <div id="profile-overlay" class="overlay">
        <div class="portal-content w-full max-w-md mx-auto">
            <div class="w-24 h-24 rounded-full bg-white/10 flex items-center justify-center mb-4 border border-white/20 overflow-hidden relative">
                <div id="portal-profile-container" class="w-full h-full flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                </div>
            </div>
            <div class="text-center mb-6 space-y-1">
                <h2 id="profile-name" class="text-2xl font-black uppercase text-white">User</h2>
                <p id="profile-id" class="text-[10px] font-mono opacity-40">ID: ---</p>
                <div class="flex items-center justify-center gap-3 text-xs opacity-60 mt-2">
                    <p id="profile-bday">BDay: --/--</p><span>â€¢</span><div class="flex items-center gap-1">Color: <div id="profile-color-dot" class="w-3 h-3 rounded-full bg-cyan-400"></div></div>
                </div>
                <button onclick="openEditProfile()" class="text-[9px] text-cyan-400 uppercase tracking-widest mt-4 border-b border-cyan-400/30 pb-0.5 click-safe">Update Identity</button>
            </div>
            <div class="w-full card-glass border-t-2 border-white/20 mb-4 bg-white/5">
                <div class="flex items-center gap-2 mb-3 px-4 pt-4"><div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div><h3 class="text-[9px] font-black uppercase tracking-widest opacity-80">Celi Analysis</h3></div>
                <p id="celi-analysis-text" class="text-xs italic leading-relaxed opacity-80 px-4 pb-4">Analyzing soul...</p>
            </div>
            <div class="w-full card-glass border-red-500/20 mb-8"><p class="text-[11px] opacity-60">Void Entropy: <span id="entropy-val" class="text-red-500">0%</span></p></div>
            <div class="w-full flex gap-4 mb-8"><button onclick="confirmDelete()" class="flex-1 py-4 bg-red-900/20 text-red-400 text-[9px] font-bold uppercase rounded-xl click-safe">Delete Data</button><button onclick="window.location.href='/logout'" class="flex-1 py-4 bg-white/5 text-white text-[9px] font-bold uppercase rounded-xl click-safe">Logout</button></div>
            <div class="mt-auto text-center opacity-30 px-4"><h4 class="text-[9px] font-bold uppercase mb-2">Data Sovereignty Protocol</h4><p class="text-[8px] leading-tight">Your neural logs and star charts are encrypted in the Sovereign Vault. Personal identifiers remain local. Behavioral analysis is processed via ephemeral AI uplink and is never sold or retained externally.</p></div>
            <button onclick="closeUI()" class="close-btn-red mt-6 click-safe">X</button>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/95 z-[6000] hidden items-center justify-center p-8"><div class="glass w-full max-w-sm p-8 rounded-3xl border border-white/10 bg-gray-900"><h3 class="text-xl font-black uppercase mb-6 text-center">Update Signal</h3><div class="mb-4"><label class="text-[9px] uppercase opacity-50 block mb-2">Profile Picture</label><input type="file" id="edit-pic" accept="image/*" class="w-full text-xs text-white"></div><div class="mb-4"><label class="text-[9px] uppercase opacity-50 block mb-2">Date of Birth</label><input type="date" id="edit-bday" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white text-xs"></div><div class="mb-6"><label class="text-[9px] uppercase opacity-50 block mb-2">Resonance Color</label><input type="color" id="edit-color" class="bg-transparent w-full h-10 rounded-xl overflow-hidden border-none" value="#00f2fe"></div><div class="flex gap-2"><button onclick="saveProfile()" class="flex-1 py-3 bg-white text-black font-bold uppercase rounded-xl text-xs click-safe">Confirm</button><button onclick="document.getElementById('edit-modal').style.display='none'" class="flex-1 py-3 bg-white/10 text-white font-bold uppercase rounded-xl text-xs click-safe">Cancel</button></div></div></div>
    <div id="rank-portal-overlay" class="overlay"><div class="portal-content w-full max-w-md mx-auto"><h2 class="text-2xl font-black text-white mb-10 uppercase tracking-widest">Cosmic Portal</h2><div id="portal-rank-icon" class="w-32 h-32 rounded-full flex items-center justify-center mb-6 bg-black/40 backdrop-blur-xl border-2"></div><div id="portal-level-stars" class="flex gap-2 mb-6 text-cyan-400"></div><div class="w-full flex items-center gap-4 mb-2"><div class="flex-grow h-2 bg-white/10 rounded-full overflow-hidden"><div id="portal-progress-bar" class="h-full bg-cyan-400 transition-all duration-1000" style="width: 0%"></div></div><p id="portal-points" class="text-xs font-bold text-white whitespace-nowrap">0 / 0 Stars</p></div><h2 id="portal-rank-name" class="text-3xl font-black uppercase tracking-tighter text-cyan-400 mb-8">---</h2><div class="w-full card-glass border-l-4 border-cyan-400 mb-8 bg-white/5"><p id="portal-synthesis-text" class="text-sm italic leading-relaxed text-white/90"></p></div><div id="portal-future-list" class="w-full space-y-6 pb-4"></div><button onclick="closeUI()" class="close-btn-red click-safe">X</button></div></div>
    <div id="chat-overlay" class="overlay" style="padding: 130px 25px 100px;"><div id="chat-scroller" class="flex flex-col-reverse overflow-y-auto flex-grow pb-4"><div id="msg-container" class="flex flex-col"></div></div><div id="typing-indicator" class="typing" style="display:none; color:#00f2fe; font-size:12px; margin-bottom:10px;">Celi is reflecting...</div><div class="pb-10 pt-4"><textarea id="msg-input" class="w-full bg-white/5 rounded-3xl p-6 text-white outline-none border border-white/10" placeholder="Speak..."></textarea><button onclick="sendAction()" class="mt-4 w-full py-5 bg-white text-black font-black uppercase rounded-2xl click-safe">Transmit</button><button onclick="closeUI()" class="mt-4 w-full text-[10px] opacity-20 uppercase text-center click-safe">Minimize</button></div></div>
    <div id="archive-overlay" class="overlay"><div class="portal-content"><h2 class="text-3xl font-black mb-8 uppercase">Archive</h2><div id="archive-list" class="space-y-4 w-full"></div><button onclick="closeUI()" class="close-btn-red click-safe">X</button></div></div>
    <div id="vault-overlay" class="overlay"><div class="portal-content"><h2 class="text-3xl font-black mb-8 uppercase">Vault</h2><div id="vault-content" class="space-y-4 w-full"></div><button onclick="closeUI()" class="close-btn-red click-safe">X</button></div></div>
    <div id="intent-modal" class="fixed inset-0 bg-black/95 z-[6000] hidden items-center justify-center"><div class="text-center p-10 space-y-4 w-full"><button onclick="startChat('journal')" class="w-full py-6 bg-white text-black font-black uppercase rounded-xl click-safe">Grow Star</button><button onclick="startChat('rant')" class="w-full py-6 bg-white/10 text-white font-black border border-white/20 uppercase rounded-xl click-safe">Cast Void</button><button onclick="closeUI()" class="opacity-20 uppercase text-[10px] mt-4 click-safe">Close</button></div></div>

    <script>
        let cachedData = { username: "Traveler", rank: "Observer I", profile_pic: null, celi_analysis: "System Offline" };
        const PHASE_COLORS = { "The Awakening Phase": "#00f2fe", "The Ignition Phase": "#fbbf24", "The Expansion Phase": "#8b5cf6", "The Singularity": "#ffffff" };

        function log(msg) { document.getElementById('debug-status').innerText = msg; console.log(msg); }

        if ('serviceWorker' in navigator) {
            // KILL ALL SWs
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) { registration.unregister(); }
                log("Cache Killed. Direct Uplink.");
            });
        }

        function toTitleCase(str) { return str ? str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();}) : 'Traveler'; }
        function romanToInt(roman) { const map = {"I":1,"II":2,"III":3,"IV":4,"V":5}; return map[roman] || 1; }

        function renderProfileImage(base64) {
            const h = document.getElementById('header-profile-container');
            const p = document.getElementById('portal-profile-container');
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" class="w-full h-full text-white opacity-80 p-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`;
            if(base64 && base64.length>10) {
                h.innerHTML = `<img src="${base64}" class="profile-img-header" />`;
                p.innerHTML = `<img src="${base64}" class="profile-img-portal" />`;
            } else { h.innerHTML = svg; p.innerHTML = svg; }
        }

        function renderPortalData() {
            const phaseColor = PHASE_COLORS[cachedData.phase] || "#00f2fe";
            document.documentElement.style.setProperty('--mood', phaseColor);
            
            document.getElementById('mini-rank-logo').innerHTML = `<div class="w-3 h-3 bg-white rounded-full shadow-[0_0_8px_currentColor]" style="color:${phaseColor}"></div>`;
            const large = document.getElementById('portal-rank-icon');
            large.style.borderColor = phaseColor; large.style.boxShadow = `0 0 40px ${phaseColor}66`;
            if(cachedData.rank && cachedData.rank.includes("Observer")) { large.innerHTML = `<div class="w-16 h-16 bg-white rounded-full shadow-[0_0_50px_currentColor] animate-pulse" style="color:${phaseColor}"></div>`; }
            else { large.innerHTML = `<div class="w-16 h-16 border-4 rotate-45 shadow-[0_0_20px_currentColor]" style="color:${phaseColor}; border-color:${phaseColor}"></div>`; }
            
            const count = romanToInt(cachedData.rank_roman || "I");
            document.getElementById('portal-level-stars').innerHTML = Array(count).fill(`<div class="star-four-point" style="color:${phaseColor}"></div>`).join('');
            document.getElementById('portal-rank-name').innerText = cachedData.rank;
            document.getElementById('portal-rank-name').style.color = phaseColor;
            document.getElementById('portal-progress-bar').style.width = cachedData.rank_progress + '%';
            document.getElementById('portal-progress-bar').style.backgroundColor = phaseColor;
            document.getElementById('portal-synthesis-text').innerText = cachedData.rank_synthesis || "Connecting...";
            
            const list = document.getElementById('portal-future-list');
            if(cachedData.rank_config) {
                let currentPhase = ""; let html = "";
                cachedData.rank_config.forEach(r => {
                    const pColor = PHASE_COLORS[r.phase];
                    if(r.phase !== currentPhase) { currentPhase = r.phase; html += `<div class="text-[8px] font-bold uppercase tracking-widest mt-6 mb-2 pl-2 border-l-2" style="color:${pColor}; border-color:${pColor}44">${currentPhase}</div>`; }
                    const isUnlocked = (cachedData.points || 0) >= r.threshold;
                    html += `<div class="flex justify-between items-center py-2 px-2 border-b border-white/5"><span class="text-[10px] font-black uppercase" style="color:${isUnlocked ? pColor : 'rgba(255,255,255,0.3)'}">${r.name}</span><span class="text-[8px] uppercase opacity-40">${isUnlocked ? 'ALIGNED' : `${r.threshold - (cachedData.points || 0)} Stars`}</span></div>`;
                });
                list.innerHTML = html;
            }
        }

        async function sync() {
            log("Syncing...");
            try {
                const r = await fetch('/api/data');
                if(!r.ok) throw new Error("Server " + r.status);
                const d = await r.json();
                cachedData = d;
                
                document.getElementById('greeting').innerText = `Hello, ${toTitleCase(d.username)}!`;
                document.getElementById('rank-display').innerText = d.rank || 'Observer III';
                document.getElementById('rank-bar').style.width = (d.rank_progress || 0) + '%';
                
                renderPortalData();
                renderProfileImage(d.profile_pic);
                
                document.getElementById('profile-name').innerText = d.username;
                document.getElementById('profile-id').innerText = `ID: ${d.user_id || '---'}`;
                document.getElementById('profile-bday').innerText = `BDay: ${d.birthday || '--'}`;
                document.getElementById('profile-color-dot').style.backgroundColor = d.fav_color || '#00f2fe';
                document.getElementById('celi-analysis-text').innerText = d.celi_analysis || 'Processing...';
                document.getElementById('entropy-val').innerText = (d.void_count || 0) + '%';
                document.getElementById('edit-bday').value = (!d.birthday || d.birthday === 'Unset') ? '' : d.birthday;
                document.getElementById('edit-color').value = d.fav_color || '#00f2fe';
                
                document.getElementById('archive-list').innerHTML = (d.unlocked_trivias||[]).map(t => `<div class="card-glass text-[11px] opacity-80">${t}</div>`).join('');
                document.getElementById('vault-content').innerHTML = Object.entries(d.history||{}).reverse().map(([k, v]) => `<div class="card-glass border-l-2 ${v.type==='journal'?'border-cyan-400':'border-red-500'}"><p class="text-[8px] uppercase opacity-40">${v.date}</p><p class="text-sm mt-1">${v.summary}</p></div>`).join('');
                
                log("System Ready");
            } catch(e) { 
                log("Offline Mode Active (" + e.message + ")");
                ren
