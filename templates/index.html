<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Celi Sovereign</title>
    <link rel="manifest" href="/static/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mood: #00f2fe; }
        html, body { background: #000; color: #fff; overflow: hidden; height: 100%; width: 100%; font-family: sans-serif; margin: 0; touch-action: none; }
        
        /* OVERLAY DEFAULT HIDDEN */
        .overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; padding: 0; }
        
        .portal-content { padding: 80px 25px 100px; overflow-y: auto; height: 100%; display: flex; flex-direction: column; align-items: center; }
        .card-glass { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 20px; margin-bottom: 12px; }
        
        /* BUTTONS ALWAYS CLICKABLE */
        .click-safe { pointer-events: auto !important; cursor: pointer; z-index: 4000; }
        
        .star-four-point { width: 12px; height: 12px; background: currentColor; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .close-btn-red { width: 48px; height: 48px; border-radius: 50%; background: rgba(220, 38, 38, 0.2); border: 1px solid rgba(220, 38, 38, 0.5); display: flex; align-items: center; justify-content: center; color: rgba(220, 38, 38, 0.8); margin-top: auto; margin-bottom: 20px; }
    </style>
</head>
<body>

    <header class="fixed top-0 w-full z-[3000] px-6 py-2 bg-white/5 backdrop-blur-md border-b border-white/5 shadow-lg">
        <div class="flex justify-between items-center h-full">
            <div class="flex flex-col justify-center gap-1 click-safe" onclick="openTab('rank-portal')">
                <h1 id="greeting" class="text-xl font-bold tracking-tight text-white/90 leading-none">Hello</h1>
                <div class="flex items-center gap-3">
                    <div id="mini-rank-logo" class="w-8 h-8 rounded-full bg-cyan-400/20 border border-cyan-400 flex items-center justify-center"></div>
                    <div class="flex flex-col justify-center w-24">
                        <p id="rank-display" class="text-[10px] font-black text-cyan-400 tracking-widest uppercase leading-none mb-1">LOADING...</p>
                        <div class="w-full h-1 bg-white/10 rounded-full overflow-hidden"><div id="rank-bar" class="h-full bg-cyan-400" style="width: 0%"></div></div>
                    </div>
                </div>
            </div>
            <div onclick="openTab('profile')" class="w-12 h-12 bg-white/5 border border-white/10 rounded-2xl flex items-center justify-center click-safe">
                <div class="w-4 h-4 bg-white/50 rounded-full"></div>
            </div>
        </div>
    </header>

    <main id="galaxy-container" class="fixed inset-0 overflow-hidden"></main>

    <nav class="fixed bottom-10 left-1/2 -translate-x-1/2 w-[92%] h-[75px] rounded-[38px] bg-white/5 backdrop-blur-3xl flex items-center justify-around z-[4000] border border-white/10">
        <div onclick="openTab('vault')" class="text-[8px] font-bold uppercase opacity-40 click-safe">Vault</div>
        <div onclick="openTab('archive')" class="text-[8px] font-bold uppercase opacity-40 click-safe">Archive</div>
        <div onclick="showIntent()" class="w-12 h-12 bg-white rounded-full flex items-center justify-center click-safe"><div class="w-4 h-0.5 bg-black"></div></div>
        <div onclick="closeAll()" class="text-[8px] font-bold uppercase text-cyan-400 click-safe">Galaxy</div>
        <div onclick="openTab('profile')" class="text-[8px] font-bold uppercase opacity-40 click-safe">Profile</div>
    </nav>
    
    <div class="fixed bottom-2 w-full text-center z-[5000] pointer-events-none opacity-30 text-[8px] font-mono tracking-widest text-white">Celi_AI v10.33 (Stable)</div>

    <div id="rank-portal-overlay" class="overlay">
        <div class="portal-content w-full max-w-md mx-auto">
            <h2 class="text-2xl font-black text-white mb-10 uppercase tracking-widest">Cosmic Portal</h2>
            <div id="portal-rank-icon" class="w-32 h-32 rounded-full flex items-center justify-center mb-6 bg-black/40 border-2 border-cyan-400"></div>
            <div id="portal-level-stars" class="flex gap-2 mb-6 text-cyan-400"></div>
            <div class="w-full flex items-center gap-4 mb-2"><div class="flex-grow h-2 bg-white/10 rounded-full"><div id="portal-progress-bar" class="h-full bg-cyan-400" style="width: 0%"></div></div><p id="portal-points" class="text-xs">0 / 0</p></div>
            <h2 id="portal-rank-name" class="text-3xl font-black uppercase text-cyan-400 mb-8">---</h2>
            <div class="w-full card-glass border-l-4 border-cyan-400 mb-8 bg-white/5"><p id="portal-synthesis-text" class="text-sm italic p-4">Loading...</p></div>
            <div id="portal-future-list" class="w-full space-y-2 pb-4"></div>
            <button onclick="closeAll()" class="close-btn-red click-safe">X</button>
        </div>
    </div>

    <div id="profile-overlay" class="overlay">
        <div class="portal-content w-full max-w-md mx-auto">
            <div class="w-20 h-20 rounded-full bg-white/10 flex items-center justify-center mb-6">User</div>
            <h2 id="profile-name" class="text-2xl font-black uppercase text-white">User</h2>
            <p id="profile-id" class="text-[10px] opacity-40 mb-4">ID: ---</p>
            <div class="flex gap-3 text-xs opacity-60"><p id="profile-bday">BDay: --</p><div id="profile-color-dot" class="w-3 h-3 rounded-full bg-cyan-400"></div></div>
            <button onclick="document.getElementById('edit-modal').style.display='flex'" class="text-[9px] text-cyan-400 uppercase mt-4 border-b border-cyan-400/30 click-safe">Edit Info</button>
            <div class="w-full card-glass mt-6"><p id="celi-analysis-text" class="text-xs italic p-4">Analyzing...</p></div>
            <div class="w-full flex gap-4 mt-8"><button onclick="wipeData()" class="flex-1 py-4 bg-red-900/20 text-red-400 text-[9px] font-bold uppercase rounded-xl click-safe">Wipe</button><button onclick="window.location.href='/logout'" class="flex-1 py-4 bg-white/5 text-white text-[9px] font-bold uppercase rounded-xl click-safe">Logout</button></div>
            <button onclick="closeAll()" class="close-btn-red mt-6 click-safe">X</button>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/95 z-[6000] hidden items-center justify-center p-8">
        <div class="bg-gray-900 w-full max-w-sm p-8 rounded-3xl border border-white/10">
            <input type="date" id="edit-bday" class="w-full bg-white/5 rounded-xl p-4 text-white mb-4 outline-none text-xs">
            <input type="color" id="edit-color" class="w-full h-10 mb-6 bg-transparent border-none">
            <div class="flex gap-2"><button onclick="saveProfile()" class="flex-1 py-3 bg-white text-black font-bold uppercase rounded-xl text-xs click-safe">Save</button><button onclick="document.getElementById('edit-modal').style.display='none'" class="flex-1 py-3 bg-white/10 text-white font-bold uppercase rounded-xl text-xs click-safe">Cancel</button></div>
        </div>
    </div>

    <div id="intent-modal" class="fixed inset-0 bg-black/95 z-[6000] hidden items-center justify-center">
        <div class="text-center w-full"><button onclick="alert('Journaling...')" class="py-6 px-10 bg-white text-black font-black uppercase rounded-xl click-safe">Grow Star</button><button onclick="closeAll()" class="block mt-4 opacity-50 text-[10px] click-safe">Close</button></div>
    </div>

    <script>
        // 1. KILL SWITCH: Unregister any existing Service Workers to clear cache
        if(navigator.serviceWorker) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) { registration.unregister(); } 
                console.log("Service Workers Purged");
            });
        }

        let cachedData = {};

        // 2. SAFE UI CONTROLS
        function openTab(id) {
            document.querySelectorAll('.overlay').forEach(el => el.style.display = 'none');
            const target = document.getElementById(id + '-overlay');
            if(target) target.style.display = 'flex';
        }
        function closeAll() {
            document.querySelectorAll('.overlay, #intent-modal, #edit-modal').forEach(el => el.style.display = 'none');
        }
        function showIntent() { document.getElementById('intent-modal').style.display = 'flex'; }

        // 3. MODULAR SYNC (Won't crash if one part fails)
        async function sync() {
            try {
                const res = await fetch('/api/data');
                const d = await res.json();
                cachedData = d;
                
                try { updateHeader(d); } catch(e) { console.error("Header Error", e); }
                try { updateProfile(d); } catch(e) { console.error("Profile Error", e); }
                try { updatePortal(d); } catch(e) { console.error("Portal Error", e); }
                
            } catch(e) {
                console.error("Fetch Error", e);
                document.getElementById('greeting').innerText = "Offline Mode";
            }
        }

        function updateHeader(d) {
            document.getElementById('greeting').innerText = `Hello, ${d.username || 'Traveler'}!`;
            document.getElementById('rank-display').innerText = d.rank || 'OBSERVER';
            document.getElementById('rank-bar').style.width = (d.rank_progress || 0) + '%';
        }

        function updateProfile(d) {
            document.getElementById('profile-name').innerText = d.username;
            document.getElementById('profile-id').innerText = d.user_id;
            document.getElementById('profile-bday').innerText = d.birthday;
            document.getElementById('profile-color-dot').style.backgroundColor = d.fav_color;
            document.getElementById('celi-analysis-text').innerText = d.celi_analysis;
        }

        function updatePortal(d) {
            document.getElementById('portal-rank-name').innerText = d.rank;
            document.getElementById('portal-synthesis-text').innerText = d.rank_synthesis;
            document.getElementById('portal-points').innerText = `${d.points} Stars`;
            
            // Render Future List
            const list = document.getElementById('portal-future-list');
            list.innerHTML = d.rank_config.map(r => 
                `<div class="flex justify-between py-2 border-b border-white/10">
                    <span class="text-[10px] font-bold uppercase text-white/50">${r.name}</span>
                    <span class="text-[8px] opacity-30">${r.threshold} pts</span>
                </div>`
            ).join('');
        }

        async function saveProfile() {
            const b = document.getElementById('edit-bday').value;
            const c = document.getElementById('edit-color').value;
            await fetch('/api/update_profile', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({birthday:b, fav_color:c})});
            closeAll(); sync();
        }

        async function wipeData() {
            if(confirm("Delete everything?")) {
                await fetch('/api/delete_user', {method:'POST'});
                window.location.reload();
            }
        }

        window.onload = () => { sync(); setInterval(sync, 10000); };
    </script>
</body>
</html>
