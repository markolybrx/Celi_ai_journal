<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Celi: AI Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --rank-color: #3B82F6; --mood-color: #A855F7; }
        html, body { background: #000; color: #fff; margin: 0; padding: 0; overflow: hidden; height: 100%; font-family: sans-serif; }
        
        /* Galaxy Expansion Layer */
        #galaxy-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: radial-gradient(circle at 50% 100%, #03030a 0%, #000 100%); z-index: 80; transform: translateY(100%); transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden; }
        #galaxy-layer.active { transform: translateY(0); }
        .bg-star { position: absolute; background: #fff; border-radius: 50%; opacity: 0.3; animation: twinkle var(--d) infinite ease-in-out; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 0.6; transform: scale(1.3); } }

        /* Constellation Lines */
        #constellation-svg { position: absolute; inset: 0; pointer-events: none; z-index: 90; }
        .constellation-path { stroke: rgba(255, 255, 255, 0.12); stroke-width: 1.5; stroke-dasharray: 6; animation: flow 15s linear infinite; }
        @keyframes flow { from { stroke-dashoffset: 120; } to { stroke-dashoffset: 0; } }

        /* Floating UI Elements */
        header { position: fixed; top: 0; width: 100%; z-index: 100; background: rgba(0,0,0,0.7); backdrop-filter: blur(20px); padding: 30px 24px; transition: transform 0.6s; }
        header.collapsed { transform: translateY(-100%); }
        .scroll-area { position: absolute; inset: 0; overflow-y: scroll; padding: 180px 24px 250px; scrollbar-width: none; z-index: 10; }
        
        #void-anchor { position: fixed; bottom: 130px; left: 24px; z-index: 400; width: 64px; height: 64px; border-radius: 50%; background: #000; border: 2px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }
        .bh-inner { position: absolute; width: 35px; height: 35px; border-radius: 50%; box-shadow: inset 0 0 12px #fff, 0 0 20px var(--mood-color); animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* High-Contrast Galaxy Button */
        .galaxy-btn { color: #fff !important; font-weight: 900 !important; }
        .galaxy-btn svg { stroke: #fff !important; stroke-width: 3px !important; filter: drop-shadow(0 0 8px #fff); opacity: 1 !important; }

        /* Navigation Bar */
        nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 94%; height: 75px; border-radius: 100px; background: rgba(255,255,255,0.06); backdrop-filter: blur(40px); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-around; z-index: 500; }
        .nav-label { font-size: 8px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; margin-top: 6px; opacity: 0.5; }

        /* Unlocked Star Points */
        .unlocked-star { position: absolute; width: 10px; height: 10px; border-radius: 50%; cursor: pointer; z-index: 110; transition: 0.4s; }
        .unlocked-star:hover { transform: scale(2.5); z-index: 200; filter: brightness(1.3); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); backdrop-filter: blur(25px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-body { width: 100%; max-width: 440px; background: #080808; border-radius: 48px; border: 1px solid rgba(255,255,255,0.1); padding: 40px; text-align: center; }
    </style>
</head>
<body>
    <header id="app-header">
        <div class="flex justify-between items-start">
            <div>
                <div id="greet" class="text-2xl font-black">Celi</div>
                <div class="flex items-center gap-3 mt-1">
                    <div id="rank-name" class="text-[9px] font-black uppercase text-blue-400">Observer V</div>
                    <div class="w-24 h-1 bg-white/10 rounded-full overflow-hidden">
                        <div id="rank-bar" class="h-full bg-blue-500 transition-all duration-1000"></div>
                    </div>
                </div>
            </div>
            <div class="w-10 h-10 rounded-full border border-white/20 flex items-center justify-center text-[10px] font-bold">ME</div>
        </div>
    </header>

    <main class="scroll-area" id="feed"></main>

    <div id="galaxy-layer">
        <div id="ambient-field"></div>
        <svg id="constellation-svg"></svg>
        <div id="constellation-field" class="relative w-full h-full"></div>
        <audio id="ambient-sound" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>
    </div>

    <div id="void-anchor">
        <div class="bh-inner"></div>
        <div id="void-counter" class="relative z-10 text-[10px] font-black">0</div>
    </div>

    <div id="celi-trigger" onclick="toggleDecision()" class="fixed bottom-[130px] right-[24px] z-[400] w-[68px] h-[68px] bg-white/10 border-2 border-white/20 rounded-full flex items-center justify-center">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    </div>

    <div id="decision-modal" class="fixed bottom-[210px] right-[24px] bg-black/90 backdrop-blur-3xl p-2 rounded-[30px] border border-white/10 hidden flex-col z-[450]">
        <button class="p-4 text-[10px] font-black uppercase" onclick="startSession('journal')">Archive Entry</button>
        <button class="p-4 text-[10px] font-black uppercase text-purple-400" onclick="startSession('vent')">Void Release</button>
    </div>

    <div id="chat-overlay" class="modal-overlay">
        <div id="chat-frame" class="modal-body flex flex-col max-h-[85vh]">
            <div id="chat-flow" class="flex-1 overflow-y-auto flex flex-col-reverse p-4 mb-4"></div>
            <div class="flex items-center bg-white/5 p-4 rounded-3xl border border-white/10">
                <textarea id="chat-input" class="bg-transparent flex-1 outline-none resize-none h-10" placeholder="Speak..."></textarea>
                <button onclick="send()" class="w-10 h-10 bg-white rounded-full flex items-center justify-center ml-2">
                    <svg width="18" height="18" viewBox="0 0 24 24" stroke="black" stroke-width="3" fill="none"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                </button>
            </div>
            <button id="vent-btn" class="hidden mt-4 text-[9px] font-black opacity-40" onclick="consume()">Seal Void</button>
        </div>
    </div>

    <nav>
        <div class="nav-btn" onclick="openGallery()"><span class="nav-label">Gallery</span></div>
        <div class="nav-btn galaxy-btn" onclick="toggleGalaxy()"><span id="galaxy-label" class="nav-label">View Galaxy</span></div>
        <div class="nav-btn" onclick="openVault()"><span class="nav-label">Vault</span></div>
    </nav>

    <script>
        let data = {}, isGalaxyOpen = false, mode = '';

        async function sync() {
            const r = await fetch('/api/data'); data = await r.json();
            document.getElementById('void-counter').innerText = data.void_count;
            document.getElementById('rank-name').innerText = `${data.rank} ${data.level}`;
            document.getElementById('rank-bar').style.width = data.progress + '%';
            document.getElementById('rank-bar').style.backgroundColor = data.rank_color;
            
            document.getElementById('feed').innerHTML = Object.values(data.history).sort((a,b)=>b.ts-a.ts).map(e => `
                <div class="mb-12 border-l-2 pl-6" style="border-color:${e.color}">
                    <div class="text-[9px] font-black uppercase mb-2" style="color:${e.color}">${e.star} / ${e.mood}</div>
                    <div class="text-xl font-light mb-2">${e.user_msg}</div>
                    <div class="text-sm opacity-50">CELI: ${e.reply}</div>
                </div>
            `).join('');
            if(isGalaxyOpen) renderUniverse();
        }

        function toggleGalaxy() {
            isGalaxyOpen = !isGalaxyOpen;
            document.getElementById('galaxy-layer').classList.toggle('active', isGalaxyOpen);
            document.getElementById('app-header').classList.toggle('collapsed', isGalaxyOpen);
            document.getElementById('galaxy-label').innerText = isGalaxyOpen ? "Close Galaxy" : "View Galaxy";
            if(isGalaxyOpen) { document.getElementById('ambient-sound').play(); renderUniverse(); }
            else { document.getElementById('ambient-sound').pause(); }
        }

        function renderUniverse() {
            const field = document.getElementById('constellation-field');
            const svg = document.getElementById('constellation-svg');
            field.innerHTML = ''; svg.innerHTML = '';
            
            let points = [];
            const entries = Object.values(data.history).sort((a,b)=>a.ts-b.ts);
            entries.forEach((e, i) => {
                const x = 20 + (i*18)%65, y = 25 + (i*14)%55;
                const s = document.createElement('div');
                s.className = 'unlocked-star';
                s.style.cssText = `left:${x}%; top:${y}%; background-color:${e.color}; box-shadow:0 0 20px ${e.color};`;
                s.onclick = () => alert(`${e.star} Star\nMood: ${e.mood}\nSummary: ${e.summary}`);
                field.appendChild(s);
                points.push({x, y});
            });

            if(points.length > 1) {
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", `M ${points.map(p => `${p.x}% ${p.y}%`).join(' L ')}`);
                path.setAttribute("class", "constellation-path");
                path.setAttribute("fill", "none");
                svg.appendChild(path);
            }
        }

        function toggleDecision() {
            const d = document.getElementById('decision-modal');
            d.style.display = d.style.display === 'flex' ? 'none' : 'flex';
        }

        function startSession(type) {
            mode = type; toggleDecision();
            document.getElementById('chat-overlay').style.display = 'flex';
            document.getElementById('chat-flow').innerHTML = '';
            document.getElementById('vent-btn').classList.toggle('hidden', type !== 'vent');
            addBubble('celi', type==='journal' ? "Archiving your journey. Speak." : "Void is open. Release it.");
        }

        function addBubble(sender, text) {
            const b = document.createElement('div');
            b.className = `p-4 rounded-3xl mb-4 max-w-[85%] ${sender==='user'?'bg-blue-600 self-end':'bg-white/5 self-start'}`;
            b.innerText = text;
            document.getElementById('chat-flow').prepend(b);
        }

        async function send() {
            const val = document.getElementById('chat-input').value; if(!val) return;
            addBubble('user', val); document.getElementById('chat-input').value = '';
            const r = await fetch(mode==='journal'?'/api/process':'/api/process_vent', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:val})});
            const res = await r.json();
            setTimeout(() => addBubble('celi', res.reply), 600);
        }

        function consume() {
            const frame = document.getElementById('chat-frame');
            frame.animate([{transform:'scale(1) rotate(0)', opacity:1},{transform:'scale(0) translate(-400px, 400px) rotate(720deg)', opacity:0}], {duration:1000, easing:'ease-in'});
            setTimeout(()=>location.reload(), 1000);
        }

        window.onload = () => {
            sync();
            const amb = document.getElementById('ambient-field');
            for(let i=0; i<150; i++) {
                const s = document.createElement('div');
                s.className = 'bg-star';
                s.style.cssText = `left:${Math.random()*100}%; top:${Math.random()*100}%; width:2px; height:2px; --d:${Math.random()*3+2}s;`;
                amb.appendChild(s);
            }
        };
    </script>
</body>
</html>
