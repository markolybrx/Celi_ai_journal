<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Celi: Access Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mood: #00f2fe; }
        body { background: #000; color: #fff; font-family: sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        
        /* LAYOUT */
        .glass-panel { width: 90%; max-width: 380px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; overflow: hidden; transition: all 0.4s ease; max-height: 90vh; overflow-y: auto; }
        
        .input-group { margin-bottom: 15px; position: relative; }
        .input-field { width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 12px 15px; color: #fff; font-size: 13px; outline: none; transition: border-color 0.3s; }
        .input-field:focus { border-color: var(--mood); }
        .input-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: rgba(255, 255, 255, 0.5); margin-bottom: 6px; display: block; }
        .input-error { border-color: #ef4444 !important; }
        select.input-field { appearance: none; -webkit-appearance: none; }

        .btn-primary { width: 100%; padding: 14px; background: var(--mood); color: #000; border-radius: 12px; font-weight: 900; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; cursor: pointer; transition: transform 0.2s; border: none; margin-top: 10px; display: flex; align-items: center; justify-content: center; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { width: 100%; padding: 14px; background: rgba(255, 255, 255, 0.05); color: #fff; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; font-weight: bold; text-transform: uppercase; font-size: 10px; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; }
        
        /* UTILS */
        .hidden { display: none !important; }
        .text-link { color: var(--mood); cursor: pointer; text-decoration: underline; }
        
        /* ICONS */
        .icon-btn { position: absolute; right: 12px; top: 35px; cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
        .icon-btn:hover { opacity: 1; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; position: absolute; right: 12px; top: 35px; border: 1px solid rgba(255,255,255,0.2); }

        /* MODALS & LOADERS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #111; border: 1px solid rgba(255,255,255,0.15); padding: 30px; border-radius: 20px; max-width: 400px; width: 100%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .modal-title { font-size: 14px; font-weight: 900; text-transform: uppercase; margin-bottom: 10px; color: #fff; letter-spacing: 1px; }
        .modal-body { font-size: 12px; color: #ccc; line-height: 1.5; margin-bottom: 20px; }
        .privacy-content { max-height: 60vh; overflow-y: auto; text-align: left; margin-bottom: 20px; }
        .privacy-content h3 { color: #fff; margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; font-size: 10px; letter-spacing: 1px; }
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 50; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--mood); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    
    <script>
        // Force clear old service workers
        if(window.navigator && navigator.serviceWorker) { navigator.serviceWorker.getRegistrations().then(r => { for(let reg of r) reg.unregister(); }); }

        let recoveryData = {};

        // 1. Navigation Logic
        window.switchView = function(viewName) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-register').classList.add('hidden');
            document.getElementById('view-recovery').classList.add('hidden');
            
            document.getElementById('view-' + viewName).classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden'); // Reset error
        }

        // 2. UI Toggles
        window.togglePass = function(id) { 
            const el = document.getElementById(id); 
            el.type = el.type === 'password' ? 'text' : 'password'; 
        }
        window.updateColorPreview = function(val) { 
            const s = new Option().style; s.color = val; 
            if (s.color !== '') document.getElementById('color-preview').style.backgroundColor = val; 
        }

        // 3. Modals
        window.openModal = function(type, title, body) {
            if (type === 'privacy') {
                document.getElementById('privacy-modal').style.display = 'flex';
            } else {
                document.getElementById('modal-title').innerText = title || 'Notification';
                document.getElementById('modal-body').innerText = body || '';
                document.getElementById('message-modal').style.display = 'flex';
            }
        }
        window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }
        window.showLoading = function(msg) { document.getElementById('loading-text').innerText = msg; document.getElementById('loading-overlay').style.display = 'flex'; }
        window.hideLoading = function() { document.getElementById('loading-overlay').style.display = 'none'; }

        // 4. Form Handlers
        window.handleLogin = async function(e) {
            e.preventDefault();
            document.getElementById('login-error').classList.add('hidden');
            window.showLoading("Logging In...");
            
            const form = new FormData(e.target);
            // Handle Remember Me
            if(document.getElementById('remember-me').checked) {
                localStorage.setItem('celi_user', document.getElementById('login-username').value);
            } else { localStorage.removeItem('celi_user'); }

            try {
                const res = await fetch('/login', { method: 'POST', body: form });
                if (res.ok) {
                    // API sends JSON success, we manually redirect
                    window.location.href = '/';
                } else {
                    window.hideLoading();
                    document.getElementById('login-error').classList.remove('hidden');
                }
            } catch (err) {
                window.hideLoading();
                window.openModal('msg', 'Error', 'Connection Failed');
            }
        }

        window.handleRegister = async function(e) {
            e.preventDefault();
            const p1 = document.getElementById('reg-pass').value;
            const p2 = document.getElementById('confirm-pass').value;
            if(p1 !== p2) { window.openModal('msg', 'Error', 'Passwords do not match'); return; }
            
            window.showLoading("Registering...");
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const res = await fetch('/api/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                if(res.ok) {
                    window.hideLoading();
                    window.openModal('msg', 'Success', 'Account Created. Please Login.');
                    window.switchView('login');
                } else {
                    const d = await res.json();
                    window.hideLoading();
                    window.openModal('msg', 'Error', d.error || "Failed");
                }
            } catch(e) { window.hideLoading(); window.openModal('msg', 'Error', 'Network Error'); }
        }

        window.handleVerify = async function(e) {
            e.preventDefault();
            window.showLoading("Verifying...");
            const formData = new FormData(e.target);
            recoveryData = Object.fromEntries(formData.entries());
            
            try {
                const res = await fetch('/api/recover', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(recoveryData) });
                const d = await res.json();
                window.hideLoading();
                if(res.ok) {
                    document.getElementById('rec-form-1').classList.add('hidden');
                    document.getElementById('rec-form-2').classList.remove('hidden');
                    document.getElementById('rec-username').value = d.username;
                    recoveryData.username = d.username;
                } else { window.openModal('msg', 'Error', d.error || "Identity not found"); }
            } catch(e) { window.hideLoading(); window.openModal('msg', 'Error', 'Network Error'); }
        }

        window.handleReset = async function(e) {
            e.preventDefault();
            const p1 = document.getElementById('new-pass').value;
            const p2 = document.getElementById('conf-new-pass').value;
            if(p1 !== p2) { window.openModal('msg', 'Error', 'Passwords do not match'); return; }
            
            window.showLoading("Updating...");
            const payload = { ...recoveryData, new_password: p1 };
            
            try {
                const res = await fetch('/api/reset_password', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                window.hideLoading();
                if(res.ok) {
                    window.openModal('msg', 'Success', 'Password Updated.');
                    window.switchView('login');
                } else { window.openModal('msg', 'Error', 'Reset Failed'); }
            } catch(e) { window.hideLoading(); window.openModal('msg', 'Error', 'Network Error'); }
        }

        window.copyUser = function() {
            const u = document.getElementById('rec-username');
            u.select(); document.execCommand('copy');
            window.openModal('msg', 'Success', 'Username copied.');
        }

        // Init Remember Me
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('celi_user');
            if(savedUser) {
                document.getElementById('login-username').value = savedUser;
                document.getElementById('remember-me').checked = true;
            }
        });
    </script>
</head>
<body>

    <div class="glass-panel" id="auth-container">
        
        <div id="loading-overlay">
            <div class="spinner"></div>
            <p id="loading-text" class="text-xs uppercase tracking-widest text-white/80">Processing...</p>
        </div>

        <div id="view-login">
            <h1 class="text-3xl font-black text-center mb-8 tracking-tighter text-white">Celi</h1>
            <form onsubmit="handleLogin(event)">
                <div class="input-group">
                    <label class="input-label">Username</label>
                    <input type="text" id="login-username" name="username" class="input-field" placeholder="Enter username" required>
                </div>
                <div class="input-group">
                    <label class="input-label">Password</label>
                    <input type="password" name="password" id="login-pass" class="input-field" placeholder="••••••" required>
                    <div class="icon-btn" onclick="togglePass('login-pass')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </div>
                </div>
                <div class="flex items-center justify-between mb-4 mt-2 h-6">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="remember-me" class="rounded bg-white/10 border-white/20 w-3 h-3">
                        <label for="remember-me" class="text-[9px] text-white/60 uppercase tracking-wide cursor-pointer">Remember Me</label>
                    </div>
                    <div id="login-error" class="text-[9px] text-red-500 font-bold uppercase tracking-wide hidden">Incorrect username or password</div>
                </div>
                <button type="submit" class="btn-primary">Log In</button>
            </form>
            <button type="button" onclick="switchView('register')" class="btn-secondary">Register</button>
            <div class="text-center mt-6">
                <button type="button" onclick="switchView('recovery')" class="text-[9px] text-white/40 cursor-pointer hover:text-white transition border-b border-transparent hover:border-white/40 inline-block uppercase tracking-widest bg-transparent border-none">Forgot your log in?</button>
            </div>
        </div>

        <div id="view-register" class="hidden">
            <h1 class="text-xl font-bold text-center mb-6 uppercase tracking-widest text-white/90">Registration</h1>
            <form onsubmit="handleRegister(event)">
                <div class="flex gap-2 mb-2">
                    <div class="w-1/2"><label class="input-label">First Name</label><input type="text" name="fname" class="input-field" required></div>
                    <div class="w-1/2"><label class="input-label">Last Name</label><input type="text" name="lname" class="input-field" required></div>
                </div>
                <div class="input-group"><label class="input-label">Preferred Username</label><input type="text" name="reg_username" class="input-field" required></div>
                <div class="input-group"><label class="input-label">Date of Birth</label><input type="date" name="dob" class="input-field" required></div>
                <div class="input-group">
                    <label class="input-label">Favorite Color</label>
                    <input type="text" id="color-input" name="fav_color" class="input-field" placeholder="Cyan, Gold..." oninput="updateColorPreview(this.value)">
                    <div id="color-preview" class="color-dot" style="background-color: #00f2fe;"></div>
                </div>
                <div class="input-group">
                    <label class="input-label">Secret Question</label>
                    <select name="secret_question" class="input-field" required>
                        <option value="pet">What was the name of your first pet?</option>
                        <option value="mother">What is your mother's maiden name?</option>
                        <option value="school">What elementary school did you attend?</option>
                        <option value="city">In what city were you born?</option>
                    </select>
                </div>
                <div class="input-group"><label class="input-label">Secret Answer</label><input type="text" name="secret_answer" class="input-field" placeholder="Answer..." required></div>
                <div class="input-group">
                    <label class="input-label">Password</label>
                    <input type="password" name="reg_password" id="reg-pass" class="input-field" required>
                    <div class="icon-btn" onclick="togglePass('reg-pass')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
                </div>
                <div class="input-group">
                    <label class="input-label">Confirm Password</label>
                    <input type="password" id="confirm-pass" class="input-field" required>
                    <div class="icon-btn" onclick="togglePass('confirm-pass')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
                </div>
                <div class="flex items-start gap-3 my-4">
                    <input type="checkbox" id="privacy-check" required class="mt-1 w-3 h-3 bg-white/10 border-white/20 rounded">
                    <label for="privacy-check" class="text-[10px] opacity-70 leading-tight">I agree to the <span class="text-link" onclick="openModal('privacy')">Data Privacy Disclosure</span>.</label>
                </div>
                <button type="submit" class="btn-primary">Register</button>
            </form>
            <button type="button" onclick="switchView('login')" class="btn-secondary">Back to Login</button>
        </div>

        <div id="view-recovery" class="hidden">
            <h1 class="text-xl font-bold text-center mb-6 uppercase tracking-widest text-white/90">Signal Recovery</h1>
            <form id="rec-form-1" onsubmit="handleVerify(event)">
                <p class="text-[10px] text-center mb-4 opacity-50">Verify your identity to retrieve access.</p>
                <div class="flex gap-2 mb-2"><div class="w-1/2"><label class="input-label">First Name</label><input type="text" name="fname" class="input-field" required></div><div class="w-1/2"><label class="input-label">Last Name</label><input type="text" name="lname" class="input-field" required></div></div>
                <div class="input-group"><label class="input-label">Date of Birth</label><input type="date" name="dob" class="input-field" required></div>
                <div class="input-group">
                    <label class="input-label">Secret Question</label>
                    <select name="secret_question" class="input-field" required>
                        <option value="pet">What was the name of your first pet?</option>
                        <option value="mother">What is your mother's maiden name?</option>
                        <option value="school">What elementary school did you attend?</option>
                        <option value="city">In what city were you born?</option>
                    </select>
                </div>
                <div class="input-group"><label class="input-label">Secret Answer</label><input type="text" name="secret_answer" class="input-field" required></div>
                <button type="submit" class="btn-primary">Verify Identity</button>
            </form>

            <form id="rec-form-2" class="hidden" onsubmit="handleReset(event)">
                <div class="input-group">
                    <label class="input-label">Your Username</label>
                    <input type="text" id="rec-username" class="input-field" readonly style="color:var(--mood); font-weight:bold;">
                    <div class="icon-btn" onclick="copyUser()" title="Copy Username">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-l
