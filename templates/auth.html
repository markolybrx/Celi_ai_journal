<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Celi: Access Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --mood: #00f2fe; }
        body { background: #000; color: #fff; font-family: sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .glass-panel { width: 90%; max-width: 380px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; overflow: hidden; transition: all 0.4s ease; max-height: 90vh; overflow-y: auto; }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-field { width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 12px 15px; color: #fff; font-size: 13px; outline: none; transition: border-color 0.3s; }
        .input-field:focus { border-color: var(--mood); }
        .input-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: rgba(255, 255, 255, 0.5); margin-bottom: 6px; display: block; }
        select.input-field { appearance: none; -webkit-appearance: none; }
        .btn-primary { width: 100%; padding: 14px; background: var(--mood); color: #000; border-radius: 12px; font-weight: 900; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; cursor: pointer; transition: transform 0.2s; border: none; margin-top: 10px; display: flex; align-items: center; justify-content: center; }
        .btn-secondary { width: 100%; padding: 14px; background: rgba(255, 255, 255, 0.05); color: #fff; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; font-weight: bold; text-transform: uppercase; font-size: 10px; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; }
        .icon-btn { position: absolute; right: 12px; top: 35px; cursor: pointer; opacity: 0.6; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; position: absolute; right: 12px; top: 35px; border: 1px solid rgba(255,255,255,0.2); }
        .hidden-force { display: none !important; }
        
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 50; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--mood); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #111; border: 1px solid rgba(255,255,255,0.15); padding: 30px; border-radius: 20px; max-width: 400px; width: 100%; text-align: center; }
    </style>
</head>
<body>

    <div class="glass-panel" id="auth-container">
        
        <div id="loading-overlay">
            <div class="spinner"></div>
            <p id="loading-text" class="text-xs uppercase tracking-widest text-white/80">Processing...</p>
        </div>

        <div id="view-login">
            <h1 class="text-3xl font-black text-center mb-8 tracking-tighter text-white">Celi</h1>
            <form id="form-login">
                <div class="input-group">
                    <label class="input-label">Username</label>
                    <input type="text" id="login-username" name="username" class="input-field" placeholder="Enter username" required>
                </div>
                <div class="input-group">
                    <label class="input-label">Password</label>
                    <input type="password" name="password" id="login-pass" class="input-field" placeholder="••••••" required>
                    <div class="icon-btn" id="toggle-login-pass">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </div>
                </div>
                
                <div class="flex items-center justify-between mb-4 mt-2 h-6">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="remember-me" class="rounded bg-white/10 border-white/20 w-3 h-3">
                        <label for="remember-me" class="text-[9px] text-white/60 uppercase tracking-wide cursor-pointer">Remember Me</label>
                    </div>
                    <div id="login-error" class="text-[9px] text-red-500 font-bold uppercase tracking-wide hidden-force">Incorrect username or password</div>
                </div>

                <button type="submit" class="btn-primary">Log In</button>
            </form>
            
            <button type="button" id="btn-goto-register" class="btn-secondary">Register</button>
            
            <div class="text-center mt-6">
                <button type="button" id="btn-goto-recovery" class="text-[9px] text-white/40 cursor-pointer hover:text-white transition border-b border-transparent hover:border-white/40 inline-block uppercase tracking-widest bg-transparent border-none">Forgot your log in?</button>
            </div>
        </div>

        <div id="view-register" class="hidden-force">
            <h1 class="text-xl font-bold text-center mb-6 uppercase tracking-widest text-white/90">Registration</h1>
            <form id="form-register">
                <div class="flex gap-2 mb-2">
                    <div class="w-1/2"><label class="input-label">First Name</label><input type="text" name="fname" class="input-field" required></div>
                    <div class="w-1/2"><label class="input-label">Last Name</label><input type="text" name="lname" class="input-field" required></div>
                </div>
                <div class="input-group"><label class="input-label">Preferred Username</label><input type="text" name="reg_username" class="input-field" required></div>
                <div class="input-group"><label class="input-label">Date of Birth</label><input type="date" name="dob" class="input-field" required></div>
                <div class="input-group">
                    <label class="input-label">Favorite Color</label>
                    <input type="text" id="color-input" name="fav_color" class="input-field" placeholder="Cyan, Gold..." oninput="document.getElementById('color-preview').style.backgroundColor = this.value">
                    <div id="color-preview" class="color-dot" style="background-color: #00f2fe;"></div>
                </div>
                <div class="input-group">
                    <label class="input-label">Secret Question</label>
                    <select name="secret_question" class="input-field" required>
                        <option value="pet">What was the name of your first pet?</option>
                        <option value="mother">What is your mother's maiden name?</option>
                        <option value="school">What elementary school did you attend?</option>
                        <option value="city">In what city were you born?</option>
                    </select>
                </div>
                <div class="input-group"><label class="input-label">Secret Answer</label><input type="text" name="secret_answer" class="input-field" placeholder="Answer..." required></div>
                <div class="input-group">
                    <label class="input-label">Password</label>
                    <input type="password" name="reg_password" id="reg-pass" class="input-field" required>
                </div>
                <div class="input-group">
                    <label class="input-label">Confirm Password</label>
                    <input type="password" id="confirm-pass" class="input-field" required>
                </div>
                <div class="flex items-start gap-3 my-4">
                    <input type="checkbox" id="privacy-check" required class="mt-1 w-3 h-3 bg-white/10 border-white/20 rounded">
                    <label for="privacy-check" class="text-[10px] opacity-70 leading-tight">I agree to the <span class="text-link" id="btn-privacy">Data Privacy Disclosure</span>.</label>
                </div>
                <button type="submit" class="btn-primary">Register</button>
            </form>
            <button type="button" id="btn-back-login-1" class="btn-secondary">Back to Login</button>
        </div>

        <div id="view-recovery" class="hidden-force">
            <h1 class="text-xl font-bold text-center mb-6 uppercase tracking-widest text-white/90">Signal Recovery</h1>
            <form id="form-verify">
                <p class="text-[10px] text-center mb-4 opacity-50">Verify your identity to retrieve access.</p>
                <div class="flex gap-2 mb-2"><div class="w-1/2"><label class="input-label">First Name</label><input type="text" name="fname" class="input-field" required></div><div class="w-1/2"><label class="input-label">Last Name</label><input type="text" name="lname" class="input-field" required></div></div>
                <div class="input-group"><label class="input-label">Date of Birth</label><input type="date" name="dob" class="input-field" required></div>
                <div class="input-group">
                    <label class="input-label">Secret Question</label>
                    <select name="secret_question" class="input-field" required>
                        <option value="pet">What was the name of your first pet?</option>
                        <option value="mother">What is your mother's maiden name?</option>
                        <option value="school">What elementary school did you attend?</option>
                        <option value="city">In what city were you born?</option>
                    </select>
                </div>
                <div class="input-group"><label class="input-label">Secret Answer</label><input type="text" name="secret_answer" class="input-field" required></div>
                <button type="submit" class="btn-primary">Verify Identity</button>
            </form>

            <form id="form-reset" class="hidden-force">
                <div class="input-group">
                    <label class="input-label">Your Username</label>
                    <input type="text" id="rec-username" class="input-field" readonly style="color:var(--mood); font-weight:bold;">
                </div>
                <div class="input-group">
                    <label class="input-label">New Password</label>
                    <input type="password" id="new-pass" class="input-field" required>
                </div>
                <div class="input-group">
                    <label class="input-label">Confirm New Password</label>
                    <input type="password" id="conf-new-pass" class="input-field" required>
                </div>
                <button type="submit" class="btn-primary">Confirm Reset</button>
            </form>
            <button type="button" id="btn-back-login-2" class="btn-secondary">Cancel</button>
        </div>
    </div>

    <div class="fixed bottom-4 w-full text-center pointer-events-none opacity-30 text-[9px] font-mono uppercase tracking-widest text-white flex flex-col gap-1">
        <span>Celi Access v1.8.0</span>
        <span class="opacity-70">Powered by Gemini AI</span>
    </div>

    <div id="message-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" class="text-sm font-bold uppercase mb-2">Notification</h3>
            <p id="modal-body" class="text-xs mb-4 text-gray-300"></p>
            <button id="btn-close-modal" class="btn-primary">Dismiss</button>
        </div>
    </div>

    <div id="privacy-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="text-sm font-bold uppercase mb-4">Data & Privacy</h2>
            <div class="text-left text-xs text-gray-400 h-40 overflow-y-auto mb-4">
                <p class="mb-2">1. Celi uses MongoDB Atlas (Encrypted) for storage.</p>
                <p class="mb-2">2. Google Gemini is used for AI processing only. No data training.</p>
                <p class="mb-2">3. You own your data. Delete anytime.</p>
            </div>
            <button id="btn-close-privacy" class="btn-primary">I Acknowledge</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Celi Auth v1.8.0 Initializing...");

            // 0. SERVICE WORKER KILLER
            if(window.navigator && navigator.serviceWorker) {
                navigator.serviceWorker.getRegistrations().then(r => { for(let reg of r) reg.unregister(); });
            }

            // 1. HELPERS
            const get = (id) => document.getElementById(id);
            const show = (id) => get(id).style.setProperty('display', 'block', 'important');
            const hide = (id) => get(id).style.setProperty('display', 'none', 'important');
            
            // 2. VIEW SWITCHING
            function switchView(view) {
                console.log("Switching to:", view);
                ['view-login', 'view-register', 'view-recovery'].forEach(v => hide(v));
                show('view-' + view);
                hide('login-error');
            }

            // 3. EVENT BINDINGS (The Fix)
            get('btn-goto-register').addEventListener('click', () => switchView('register'));
            get('btn-goto-recovery').addEventListener('click', () => switchView('recovery'));
            get('btn-back-login-1').addEventListener('click', () => switchView('login'));
            get('btn-back-login-2').addEventListener('click', () => switchView('login'));

            // Toggle Passwords
            get('toggle-login-pass').addEventListener('click', () => {
                const el = get('login-pass'); el.type = el.type === 'password' ? 'text' : 'password';
            });

            // Modals
            get('btn-privacy').addEventListener('click', () => show('privacy-modal'));
            get('btn-close-privacy').addEventListener('click', () => hide('privacy-modal'));
            get('btn-close-modal').addEventListener('click', () => hide('message-modal'));

            // 4. FORMS
            // LOGIN
            get('form-login').addEventListener('submit', async (e) => {
                e.preventDefault();
                hide('login-error');
                show('loading-overlay');
                
                // Remember Me
                if(get('remember-me').checked) localStorage.setItem('celi_user', get('login-username').value);
                else localStorage.removeItem('celi_user');

                const form = new FormData(e.target);
                try {
                    const res = await fetch('/login', { method: 'POST', body: form });
                    const data = await res.json();
                    
                    if (data.status === 'success') {
                        window.location.href = '/';
                    } else {
                        hide('loading-overlay');
                        // FORCE SHOW ERROR
                        show('login-error');
                    }
                } catch (err) {
                    hide('loading-overlay');
                    alert("Connection Error");
                }
            });

            // REGISTER
            get('form-register').addEventListener('submit', async (e) => {
                e.preventDefault();
                if(get('reg-pass').value !== get('confirm-pass').value) { alert("Passwords do not match"); return; }
                
                show('loading-overlay');
                const data = Object.fromEntries(new FormData(e.target));
                
                try {
                    const res = await fetch('/api/register', { 
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
                    });
                    const d = await res.json();
                    hide('loading-overlay');
                    
                    if(res.ok) {
                        alert("Success! Please Login.");
                        switchView('login');
                    } else {
                        alert(d.error || "Failed");
                    }
                } catch(e) { hide('loading-overlay'); alert("Network Error"); }
            });

            // RECOVERY
            get('form-verify').addEventListener('submit', async (e) => {
                e.preventDefault();
                show('loading-overlay');
                const data = Object.fromEntries(new FormData(e.target));
                window.recoveryData = data;
                
                try {
                    const res = await fetch('/api/recover', { 
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
                    });
                    const d = await res.json();
                    hide('loading-overlay');
                    
                    if(res.ok) {
                        hide('form-verify');
                        show('form-reset');
                        get('rec-username').value = d.username;
                        window.recoveryData.username = d.username;
                    } else {
                        alert(d.error || "Identity not found");
                    }
                } catch(e) { hide('loading-overlay'); alert("Network Error"); }
            });

            get('form-reset').addEventListener('submit', async (e) => {
                e.preventDefault();
                if(get('new-pass').value !== get('conf-new-pass').value) { alert("Passwords mismatch"); return; }
                
                show('loading-overlay');
                const payload = { ...window.recoveryData, new_password: get('new-pass').value };
                
                try {
                    const res = await fetch('/api/reset_password', { 
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                    });
                    hide('loading-overlay');
                    if(res.ok) {
                        alert("Password Updated.");
                        switchView('login');
                    } else { alert("Failed"); }
                } catch(e) { hide('loading-overlay'); alert("Network Error"); }
            });

            // 5. RESTORE SAVED USER
            const savedUser = localStorage.getItem('celi_user');
            if(savedUser) {
                get('login-username').value = savedUser;
                get('remember-me').checked = true;
            }
        });
    </script>
</body>
    </html>
    
