<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Celi: Access Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        if(window.navigator && navigator.serviceWorker) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) { registration.unregister(); }
            });
        }
    </script>

    <style>
        :root { --mood: #00f2fe; }
        body { background: #000; color: #fff; font-family: sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        
        button, input { touch-action: manipulation; }
        
        /* --- PANEL --- */
        .glass-panel { width: 90%; max-width: 380px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; overflow: hidden; transition: height 0.3s ease; max-height: 90vh; overflow-y: auto; z-index: 10; }
        
        /* --- INPUTS --- */
        .input-group { margin-bottom: 15px; position: relative; }
        .input-field { width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 12px 15px; color: #fff; font-size: 13px; outline: none; transition: border-color 0.3s; }
        .input-field:focus { border-color: var(--mood); }
        .input-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: rgba(255, 255, 255, 0.5); margin-bottom: 6px; display: block; }
        .error-text { color: #ef4444; font-size: 10px; font-weight: 900; text-transform: uppercase; margin-top: 5px; margin-bottom: 10px; letter-spacing: 0.5px; text-align: center; }
        
        /* --- BUTTONS --- */
        .btn-primary { width: 100%; padding: 14px; background: var(--mood); color: #000; border-radius: 12px; font-weight: 900; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; cursor: pointer; transition: transform 0.2s; border: none; margin-top: 10px; }
        .btn-secondary { width: 100%; padding: 14px; background: rgba(255, 255, 255, 0.05); color: #fff; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; font-weight: bold; text-transform: uppercase; font-size: 10px; cursor: pointer; margin-top: 10px; }
        
        /* --- DECOR --- */
        .icon-btn { position: absolute; right: 12px; top: 35px; cursor: pointer; opacity: 0.6; padding: 5px; } 
        .color-dot { width: 20px; height: 20px; border-radius: 50%; position: absolute; right: 12px; top: 35px; border: 1px solid rgba(255,255,255,0.2); pointer-events: none; }
        .text-link { color: var(--mood); cursor: pointer; text-decoration: underline; }
        
        /* --- MODALS --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; 
            display: none; align-items: center; justify-content: center; padding: 20px; 
            backdrop-filter: blur(8px); 
        }
        
        .modal-box { 
            background: #111; border: 1px solid rgba(255,255,255,0.15); 
            border-radius: 20px; max-width: 450px; width: 100%; 
            display: flex; flex-direction: column;
            max-height: 85vh; padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            position: relative;
        }
        
        .modal-close-x {
            position: absolute; top: 15px; right: 15px; cursor: pointer;
            width: 24px; height: 24px; opacity: 0.7; z-index: 20;
        }

        .legal-box { 
            text-align: left; overflow-y: auto; flex: 1; 
            background: rgba(255,255,255,0.05); padding: 15px; 
            border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); 
        }
        
        .legal-box h3 { color: var(--mood); font-size: 11px; font-weight: bold; text-transform: uppercase; margin-top: 15px; margin-bottom: 5px; }
        .legal-box p, .legal-box li { font-size: 10px; color: #ccc; line-height: 1.5; margin-bottom: 10px; }
        .legal-box ul { list-style: disc; padding-left: 20px; }
        
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 50; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--mood); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    
    <script>
        // --- UI CONTROLLERS ---
        function switchView(viewName) {
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-register').style.display = 'none';
            document.getElementById('view-recovery').style.display = 'none';
            document.getElementById('view-' + viewName).style.display = 'block';
            document.getElementById('login-error-msg').style.display = 'none';
        }
        function togglePass(id) { const el = document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; }
        function showLoading(msg) { document.getElementById('loading-text').innerText = msg; document.getElementById('loading-overlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }
        function showModal(title, body) { 
            document.getElementById('modal-title').innerText = title; 
            document.getElementById('modal-body').innerText = body; 
            document.getElementById('message-modal').style.display = 'flex'; 
        }
        function hideModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- AUTHENTICATION ACTIONS ---
        async function doLogin(e) {
            e.preventDefault();
            document.getElementById('login-error-msg').style.display = 'none';
            showLoading("Accessing...");
            
            if(document.getElementById('remember-me').checked) { localStorage.setItem('celi_user', document.getElementById('login-username').value); } 
            else { localStorage.removeItem('celi_user'); }

            try {
                const form = new FormData(document.getElementById('form-login'));
                const res = await fetch('/login', { method: 'POST', body: form });
                const data = await res.json();
                hideLoading();
                
                if (data.status === 'success') { window.location.href = '/'; } 
                else { 
                    const errEl = document.getElementById('login-error-msg'); 
                    errEl.innerText = "Incorrect username or password."; 
                    errEl.style.display = 'block'; 
                }
            } catch (err) { hideLoading(); showModal('Error', 'Connection Failed. Check internet.'); }
        }

        async function doRegister(e) {
            e.preventDefault();
            const p1 = document.getElementById('reg-pass').value;
            const p2 = document.getElementById('confirm-pass').value;
            if (p1 !== p2) { showModal('Error', 'Passwords do not match.'); return; }
            
            showLoading("Creating Signal...");
            const form = new FormData(document.getElementById('form-register'));
            const data = Object.fromEntries(form.entries());
            
            try {
                const res = await fetch('/api/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                const d = await res.json();
                hideLoading();
                
                if (res.ok) { showModal('Success', 'Account Created! Please Log In.'); switchView('login'); } 
                else { showModal('Error', d.error || 'Registration Failed'); }
            } catch (err) { hideLoading(); showModal('Error', 'Network Error'); }
        }

        async function doVerify(e) {
            e.preventDefault();
            showLoading("Verifying...");
            const form = new FormData(document.getElementById('form-verify'));
            const data = Object.fromEntries(form.entries());
            window.recoveryData = data;
            
            try {
                const res = await fetch('/api/recover', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                const d = await res.json();
                hideLoading();
                
                if (res.ok) { 
                    document.getElementById('form-verify').style.display = 'none'; 
                    document.getElementById('form-reset').style.display = 'block'; 
                    document.getElementById('rec-username').value = d.username; 
                    window.recoveryData.username = d.username; 
                } else { showModal('Error', 'Identity Verification Failed.'); }
            } catch (err) { hideLoading(); showModal('Error', 'Network Error'); }
        }

        async function doReset(e) {
            e.preventDefault();
            const p1 = document.getElementById('new-pass').value;
            const p2 = document.getElementById('conf-new-pass').value;
            if (p1 !== p2) { showModal('Error', 'Passwords do not match'); return; }
            
            showLoading("Updating...");
            const payload = { ...window.recoveryData, new_password: p1 };
            
            try {
                const res = await fetch('/api/reset_password', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                hideLoading();
                if (res.ok) { showModal('Success', 'Password Updated.'); switchView('login'); } 
                else { showModal('Error', 'Reset Failed.'); }
            } catch (err) { hideLoading(); showModal('Error', 'Network Error'); }
        }

        window.onload = function() {
            const saved = localStorage.getItem('celi_user');
            if(saved) { document.getElementById('login-username').value = saved; document.getElementById('remember-me').checked = true; }
        };
    </script>
</head>

<body>

    <div class="glass-panel" id="auth-container">
        <div id="loading-overlay"><div class="spinner"></div><p id="loading-text" class="text-xs uppercase tracking-widest text-white/80">Processing...</p></div>

        <div id="view-login">
            <h1 class="text-3xl font-black text-center mb-8 tracking-tighter text-white">Celi</h1>
            
            <form id="form-login" onsubmit="doLogin(event)">
                <div class="input-group"><label class="input-label">Username</label><input type="text" id="login-username" name="username" class="input-field" placeholder="Enter username" required></div>
                <div class="input-group">
                    <label class="input-label">Password</label>
                    <input type="password" name="password" id="login-pass" class="input-field" placeholder="••••••" required>
                    <div class="icon-btn" onclick="togglePass('login-pass')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
                </div>
                <div class="flex items-center justify-between mb-4 mt-2">
                    <div class="flex items-center gap-2"><input type="checkbox" id="remember-me" class="rounded bg-white/10 border-white/20 w-3 h-3"><label for="remember-me" class="text-[9px] text-white/60 uppercase tracking-wide cursor-pointer">Remember Me</label></div>
                </div>
                <div id="login-error-msg" class="error-text" style="display:none;">Incorrect username or password</div>
                <button type="submit" class="btn-primary">Log In</button>
            </form>
            <button type="button" onclick="switchView('register')" class="btn-secondary">Register</button>
            <div class="text-center mt-6"><button type="button" onclick="switchView('recovery')" class="text-[9px] text-white/40 cursor-pointer hover:text-white transition border-b border-transparent hover:border-white/40 bg-transparent border-none uppercase tracking-widest">Forgot your log in?</button></div>
        </div>

        <div id="view-register" style="display:none;">
            <h1 class="text-xl font-bold text-center mb-6 uppercase tracking-widest text-white/90">Registration</h1>
            <form id="form-register" onsubmit="doRegister(event)">
                <div class="flex gap-2 mb-2"><div class="w-1/2"><label class="input-label">First Name</label><input type="text" name="fname" class="input-field" required></div><div class="w-1/2"><label class="input-label">Last Name</label><input type="text" name="lname" class="input-field" required></div></div>
                <div class="input-group"><label class="input-label">Preferred Username</label><input type="text" name="reg_username" class="input-field" required></div>
                <div class="input-group"><label class="input-label">Date of Birth</label><input type="date" name="dob" class="input-field" required></div>
                <div class="input-group">
                    <label class="input-label">Favorite Color</label>
                    <input type="text" id="color-input" name="fav_color" class="input-field" placeholder="Cyan, Gold..." oninput="document.getElementById('color-preview').style.backgroundColor = this.value">
                    <div id="color-preview" class="color-dot" style="background-color: #00f2fe;"></div>
                </div>
                <div class="input-group"><label class="input-label">Secret Question</label>
                    <select name="secret_question" class="input-field" required>
                        <option value="pet">Name of your first pet?</option>
                        <option value="mother">Mother's maiden name?</option>
                        <option value="school">First elementary school?</option>
                        <option value="city">City you were born?</option>
                    </select>
                </div>
                <div class="input-group"><label class="input-label">Secret Answer</label><input type="text" name="secret_answer" class="input-field" placeholder="Answer..." required></div>
                <div class="input-group"><label class="input-label">Password</label><input type="password" name="reg_password" id="reg-pass" class="input-field" required></div>
                <div class="input-group"><label class="input-label">Confirm Password</label><input type="password" id="confirm-pass" class="input-field" required></div>
                <div class="flex items-start gap-3 my-4">
                    <input type="checkbox" id="privacy-check" required class="mt-1 w-3 h-3 bg-white/10 border-white/20 rounded">
                    <label for="privacy-check" class="text-[10px] opacity-70 leading-tight">I agree to the <span class="text-link" onclick="document.getElementById('privacy-modal').style.display='flex'">Data Privacy Disclosure</span>.</label>
                </div>
                <button type="submit" class="btn-primary">Register</button>
            </form>
            <button type="button" onclick="switchView('login')" class="btn-secondary">Back to Login</button>
        </div>

        <div id="view-recovery" style="display:none;">
            <h1 class="text-xl font-bold text-center mb-6 uppercase tracking-widest text-white/90">Signal Recovery</h1>
            <form id="form-verify" onsubmit="doVerify(event)">
                <p class="text-[10px] text-center mb-4 opacity-50">Verify identity to retrieve access.</p>
                <div class="flex gap-2 mb-2"><div class="w-1/2"><label class="input-label">First Name</label><input type="text" name="fname" class="input-field" required></div><div class="w-1/2"><label class="input-label">Last Name</label><input type="text" name="lname" class="input-field" required></div></div>
                <div class="input-group"><label class="input-label">Date of Birth</label><input type="date" name="dob" class="input-field" required></div>
                <div class="input-group"><label class="input-label">Secret Question</label>
                    <select name="secret_question" class="input-field" required>
                        <option value="pet">Name of your first pet?</option>
                        <option value="mother">Mother's maiden name?</option>
                        <option value="school">First elementary school?</option>
                        <option value="city">City you were born?</option>
                    </select>
                </div>
                <div class="input-group"><label class="input-label">Secret Answer</label><input type="text" name="secret_answer" class="input-field" required></div>
                <button type="submit" class="btn-primary">Verify Identity</button>
            </form>
            <form id="form-reset" style="display:none;" onsubmit="doReset(event)">
                <div class="input-group"><label class="input-label">Your Username</label><input type="text" id="rec-username" class="input-field" readonly style="color:var(--mood); font-weight:bold;"></div>
                <div class="input-group"><label class="input-label">New Password</label><input type="password" id="new-pass" class="input-field" required></div>
                <div class="input-group"><label class="input-label">Confirm New Password</label><input type="password" id="conf-new-pass" class="input-field" required></div>
                <button type="submit" class="btn-primary">Confirm Reset</button>
            </form>
            <button type="button" onclick="switchView('login')" class="btn-secondary">Cancel</button>
        </div>
    </div>

    <div id="privacy-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-close-x" onclick="hideModal('privacy-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#fff" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </div>
            <h2 class="text-xl font-bold mb-4 uppercase text-white tracking-widest text-center">Data & Privacy</h2>
            <div class="legal-box">
                <h3>1. Introduction and Scope</h3>
                <p>Celi ("The Application") is designed as a personal AI journaling companion. We are committed to transparency regarding the collection, storage, and processing of your digital footprint. By creating a "Signal" (Account), you agree to these terms.</p>
                <h3>2. Data Collection</h3>
                <p>We adhere to a principle of <strong>Data Minimization</strong>. We collect:</p>
                <ul>
                    <li><strong>Username:</strong> Unique identifier.</li>
                    <li><strong>Authentication Credentials:</strong> Hashed passwords (stored using secure cryptographic hashing).</li>
                    <li><strong>Biographical Markers:</strong> Date of Birth for AI context.</li>
                    <li><strong>System Logs:</strong> Timestamps for organizing entries.</li>
                </ul>
                <h3>3. Journal and Collected Information</h3>
                <p><strong>Ownership:</strong> The User retains 100% Intellectual Property ownership of their User Content. Celi claims no ownership rights.</p>
                <p><strong>Usage:</strong> Content is accessed solely for history display and AI context generation (via ephemeral processing).</p>
                <h3>4. AI Utilisation (Artificial Intelligence)</h3>
                <p>Celi leverages <strong>Google Gemini</strong> for text generation.</p>
                <ul>
                    <li><strong>Data Transmission:</strong> Encrypted via HTTPS (TLS 1.2+).</li>
                    <li><strong>Ephemeral Processing:</strong> AI processing is stateless. Data is used to generate a response and then discarded.</li>
                    <li><strong>No Training:</strong> Celi does not grant Google rights to use your data to train public foundation models.</li>
                </ul>
                <h3>5. Data Storage & Infrastructure</h3>
                <p>Data is stored in <strong>MongoDB Atlas</strong> using <strong>AES-256 encryption</strong> at rest and TLS in transit. Infrastructure is secured by standard cloud security protocols.</p>
                <h3>6. User Data Rights</h3>
                <p>In alignment with global privacy standards:</p>
                <ul>
                    <li><strong>Right to Access:</strong> View complete history in the Vault.</li>
                    <li><strong>Right to Erasure:</strong> Permanently delete your account via Profile Settings.</li>
                </ul>
                <h3>7. User Data Security</h3>
                <p>Access is protected by passwords and Identity Verification protocols (Secret Questions). In the event of a breach, we will notify users within 72 hours.</p>
            </div>
            <button onclick="hideModal('privacy-modal')" class="btn-primary">I Acknowledge & Consent</button>
        </div>
    </div>

    <div id="message-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" class="text-sm font-bold uppercase mb-2 text-white">Notification</h3>
            <p id="modal-body" class="text-xs mb-6 text-gray-300"></p>
            <button onclick="hideModal('message-modal')" class="btn-primary">Dismiss</button>
        </div>
    </div>

</body>
</html>
